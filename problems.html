<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜ç›®ç®¡ç† - ACMä¸­è½¬ç«™</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ACMä¸­è½¬ç«™</a>
            <ul class="navbar-nav">
                <li><a href="index.html">ä»ªè¡¨æ¿</a></li>
                <li><a href="contests.html">æ¯”èµ›ç®¡ç†</a></li>
                <li><a href="problems.html" class="active">é¢˜ç›®ç®¡ç†</a></li>
            </ul>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h1 class="page-title">é¢˜ç›®ç®¡ç†</h1>
            <p class="page-subtitle">è®°å½•å’Œè¿½è¸ªä½ çš„é¢˜ç›®ç»ƒä¹ è¿›åº¦</p>
        </div>

        <!-- å¿«é€Ÿç»Ÿè®¡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-problems">0</div>
                <div class="stat-label">æ€»é¢˜ç›®æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="solved-problems">0</div>
                <div class="stat-label">å·²è§£å†³</div>
                <div class="stat-change" id="solve-rate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="platform-count">0</div>
                <div class="stat-label">ä½¿ç”¨å¹³å°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="tag-count">0</div>
                <div class="stat-label">æ ‡ç­¾ç§ç±»</div>
            </div>
        </div>

        <!-- æ·»åŠ é¢˜ç›®è¡¨å• -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æ·»åŠ æ–°é¢˜ç›®</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="resetForm()">é‡ç½®è¡¨å•</button>
                    <button class="btn btn-secondary btn-sm" onclick="importProblems()">å¯¼å…¥æ•°æ®</button>
                    <button class="btn btn-primary btn-sm" onclick="exportProblems()">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>
            <div class="form-container">
                <form id="problem-form" onsubmit="handleSubmitProblem(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="problem-title">é¢˜ç›®æ ‡é¢˜ *</label>
                            <input type="text" id="problem-title" class="form-control" placeholder="è¾“å…¥é¢˜ç›®æ ‡é¢˜" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="problem-platform">é¢˜ç›®å¹³å° *</label>
                            <select id="problem-platform" class="form-control" required>
                                <option value="">é€‰æ‹©å¹³å°</option>
                                <option value="Codeforces">Codeforces</option>
                                <option value="AtCoder">AtCoder</option>
                                <option value="CodeChef">CodeChef</option>
                                <option value="LeetCode">LeetCode</option>
                                <option value="HDU">HDU</option>
                                <option value="POJ">POJ</option>
                                <option value="UVA">UVA</option>
                                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="problem-difficulty">éš¾åº¦å€¼</label>
                            <input type="number" id="problem-difficulty" class="form-control" placeholder="å¦‚: 1200" min="800" max="3500">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="problem-status">çŠ¶æ€</label>
                            <select id="problem-status" class="form-control">
                                <option value="unsolved">âŒ æœªè§£å†³</option>
                                <option value="solved">âœ… å·²è§£å†³</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="problem-index">é¢˜ç›®ç¼–å·</label>
                            <input type="text" id="problem-index" class="form-control" placeholder="å¦‚: A, B1, Div2C">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="problem-contest">æ‰€å±æ¯”èµ›</label>
                            <select id="problem-contest" class="form-control">
                                <option value="">é€‰æ‹©æ¯”èµ›</option>
                                <!-- åŠ¨æ€åŠ è½½æ¯”èµ›é€‰é¡¹ -->
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="problem-url">é¢˜ç›®é“¾æ¥</label>
                            <input type="url" id="problem-url" class="form-control" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="problem-pdf-file">é¢˜ç›®PDFæ–‡ä»¶</label>
                            <input type="file" id="problem-pdf-file" class="form-control" accept=".pdf">
                            <div class="form-help">é€‰æ‹©é¢˜ç›®PDFæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¢˜è§£ç®¡ç†</label>
                        <div class="solution-management">
                            <button type="button" class="btn btn-outline btn-sm" onclick="openSolutionManager()">
                                ğŸ“ ç®¡ç†é¢˜è§£æ–‡ä»¶
                            </button>
                            <div class="form-help">ç‚¹å‡»ç®¡ç†é¢˜è§£æ–‡ä»¶çš„ä¸Šä¼ å’Œç»„ç»‡</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="problem-tags-input">æ ‡ç­¾</label>
                        <input type="text" id="problem-tags-input" class="form-control" placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚: dp, graph, math" onkeydown="handleTagKeydown(event)" onblur="addTagsFromInput()">
                        <div class="text-sm text-gray-500 mt-1">å¸¸ç”¨æ ‡ç­¾: dp, greedy, graph, math, string, implementation, brute-force</div>
                        <div id="selected-tags" class="tags-container mt-2"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="problem-notes">å¤‡æ³¨</label>
                        <textarea id="problem-notes" class="form-control" placeholder="è§£é¢˜æ€è·¯ã€æ˜“é”™ç‚¹ã€ç›¸å…³çŸ¥è¯†ç‚¹ç­‰"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">æ·»åŠ é¢˜ç›®</button>
                        <button type="button" class="btn btn-outline" onclick="resetForm()">æ¸…ç©º</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="search-bar">
            <div class="search-grid">
                <div class="search-input">
                    <input type="text" id="search-query" class="form-control" placeholder="æœç´¢é¢˜ç›®æ ‡é¢˜ã€æ ‡ç­¾..." onkeyup="handleSearch()">
                </div>
                <div class="form-group">
                    <select id="filter-platform" class="form-control" onchange="handleSearch()">
                        <option value="">æ‰€æœ‰å¹³å°</option>
                        <option value="Codeforces">Codeforces</option>
                        <option value="AtCoder">AtCoder</option>
                        <option value="CodeChef">CodeChef</option>
                        <option value="LeetCode">LeetCode</option>
                        <option value="HDU">HDU</option>
                        <option value="POJ">POJ</option>
                        <option value="UVA">UVA</option>
                        <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="filter-status" class="form-control" onchange="handleSearch()">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="solved">âœ… å·²è§£å†³</option>
                        <option value="unsolved">âŒ æœªè§£å†³</option>
                    </select>
                </div>
                <button class="btn btn-outline btn-sm" onclick="clearFilters()">æ¸…ç©ºç­›é€‰</button>
            </div>
            <div class="search-grid mt-2">
                <div class="form-group">
                    <label class="form-label">éš¾åº¦èŒƒå›´</label>
                    <div class="flex gap-2">
                        <input type="number" id="min-difficulty" class="form-control" placeholder="æœ€ä½" min="800" max="3500" onchange="handleSearch()">
                        <input type="number" id="max-difficulty" class="form-control" placeholder="æœ€é«˜" min="800" max="3500" onchange="handleSearch()">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ ‡ç­¾ç­›é€‰</label>
                    <select id="filter-tags" class="form-control" onchange="handleSearch()">
                        <option value="">é€‰æ‹©æ ‡ç­¾</option>
                        <!-- åŠ¨æ€åŠ è½½æ ‡ç­¾é€‰é¡¹ -->
                    </select>
                </div>
                <div class="form-group">
                    <select id="sort-by" class="form-control" onchange="handleSort()">
                        <option value="addedTime">æŒ‰æ·»åŠ æ—¶é—´æ’åº</option>
                        <option value="title">æŒ‰é¢˜ç›®æ ‡é¢˜æ’åº</option>
                        <option value="difficulty">æŒ‰éš¾åº¦æ’åº</option>
                        <option value="platform">æŒ‰å¹³å°æ’åº</option>
                        <option value="status">æŒ‰çŠ¶æ€æ’åº</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- é¢˜ç›®åˆ—è¡¨ -->
        <div class="table-container">
            <div class="table-header">
                <h3>é¢˜ç›®è®°å½•</h3>
                <div class="btn-group">
                    <span id="problem-count" class="text-gray-500">å…± 0 é“é¢˜ç›®</span>
                    <button class="btn btn-sm btn-outline" onclick="refreshData()">åˆ·æ–°</button>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="handleTableSort('title')">é¢˜ç›®æ ‡é¢˜</th>
                        <th class="sortable" onclick="handleTableSort('platform')">å¹³å°</th>
                        <th class="sortable" onclick="handleTableSort('difficulty')">éš¾åº¦</th>
                        <th class="sortable" onclick="handleTableSort('status')">çŠ¶æ€</th>
                        <th>æ ‡ç­¾</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="problems-table-body">
                    <!-- åŠ¨æ€åŠ è½½é¢˜ç›®æ•°æ® -->
                </tbody>
            </table>
            <div id="no-problems" class="text-center p-4 hidden">
                <p class="text-gray-500">æš‚æ— é¢˜ç›®è®°å½•</p>
                <p class="text-gray-500">ä½¿ç”¨ä¸Šé¢çš„è¡¨å•æ·»åŠ ä½ çš„ç¬¬ä¸€é“é¢˜ç›®å§ï¼</p>
            </div>
        </div>

        <!-- åˆ†é¡µ -->
        <div id="pagination" class="pagination hidden">
            <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)" disabled>ä¸Šä¸€é¡µ</button>
            <span class="pagination-info">ç¬¬ <span id="current-page">1</span> é¡µï¼Œå…± <span id="total-pages">1</span> é¡µ</span>
            <button class="pagination-btn" id="next-btn" onclick="changePage(1)" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- ç¼–è¾‘é¢˜ç›®æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘é¢˜ç›®</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-problem-form" onsubmit="handleUpdateProblem(event)">
                    <input type="hidden" id="edit-problem-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="edit-problem-title">é¢˜ç›®æ ‡é¢˜ *</label>
                            <input type="text" id="edit-problem-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-problem-platform">é¢˜ç›®å¹³å° *</label>
                            <select id="edit-problem-platform" class="form-control" required>
                                <option value="Codeforces">Codeforces</option>
                                <option value="AtCoder">AtCoder</option>
                                <option value="CodeChef">CodeChef</option>
                                <option value="LeetCode">LeetCode</option>
                                <option value="HDU">HDU</option>
                                <option value="POJ">POJ</option>
                                <option value="UVA">UVA</option>
                                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-problem-difficulty">éš¾åº¦å€¼</label>
                            <input type="number" id="edit-problem-difficulty" class="form-control" min="800" max="3500">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-problem-status">çŠ¶æ€</label>
                            <select id="edit-problem-status" class="form-control">
                                <option value="unsolved">âŒ æœªè§£å†³</option>
                                <option value="solved">âœ… å·²è§£å†³</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-problem-tags-input">æ ‡ç­¾</label>
                        <input type="text" id="edit-problem-tags-input" class="form-control" placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”" onkeydown="handleEditTagKeydown(event)" onblur="addEditTagsFromInput()">
                        <div id="edit-selected-tags" class="tags-container mt-2"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-problem-notes">å¤‡æ³¨</label>
                        <textarea id="edit-problem-notes" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button type="submit" form="edit-problem-form" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½ JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/problems.js"></script>
    <script src="js/search.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let storage, problemManager, globalSearch;
        let currentProblems = [];
        let currentPage = 1;
        const itemsPerPage = 15;
        let currentSort = { field: 'addedTime', order: 'desc' };
        let selectedTags = [];
        let editSelectedTags = [];
        let allTags = [];

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // åˆå§‹åŒ–å­˜å‚¨å’Œç®¡ç†å™¨
                storage = new DataStorage();
                problemManager = new ProblemManager(storage);

                // åˆå§‹åŒ–å…¨å±€æœç´¢
                try {
                    globalSearch = new GlobalSearchManager(storage);
                    console.log('å…¨å±€æœç´¢åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('åˆå§‹åŒ–å…¨å±€æœç´¢å¤±è´¥:', error);
                }

                // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                await new Promise(resolve => {
                    if (problemManager.initialized) {
                        resolve();
                    } else {
                        problemManager.on('initialized', resolve);
                    }
                });

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                
                // åŠ è½½æ•°æ®
                await loadData();
                
                console.log('é¢˜ç›®ç®¡ç†é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            problemManager.on('problemAdded', () => {
                loadData();
                showNotification('é¢˜ç›®æ·»åŠ æˆåŠŸ', 'success');
            });

            problemManager.on('problemUpdated', () => {
                loadData();
                showNotification('é¢˜ç›®æ›´æ–°æˆåŠŸ', 'success');
            });

            problemManager.on('problemDeleted', () => {
                loadData();
                showNotification('é¢˜ç›®åˆ é™¤æˆåŠŸ', 'success');
            });

            // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
        }

        // åŠ è½½æ•°æ®å¹¶æ›´æ–°UI
        async function loadData() {
            try {
                currentProblems = problemManager.getAllProblems();
                allTags = problemManager.getAllTags();
                updateStatistics();
                updateTagFilters();
                renderTable();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const stats = problemManager.getStatistics();
            
            document.getElementById('total-problems').textContent = stats.total;
            document.getElementById('solved-problems').textContent = stats.solved;
            document.getElementById('platform-count').textContent = Object.keys(stats.byPlatform).length;
            document.getElementById('tag-count').textContent = Object.keys(stats.tagStats).length;
            
            // æ›´æ–°è§£å†³ç‡
            const solveRate = stats.total > 0 ? Math.round((stats.solved / stats.total) * 100) : 0;
            document.getElementById('solve-rate').textContent = solveRate + '%';
        }

        // æ›´æ–°æ ‡ç­¾ç­›é€‰é€‰é¡¹
        function updateTagFilters() {
            const filterTags = document.getElementById('filter-tags');
            filterTags.innerHTML = '<option value="">é€‰æ‹©æ ‡ç­¾</option>' + 
                allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
        }

        // å¤„ç†æ ‡ç­¾è¾“å…¥
        function handleTagKeydown(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                addTagsFromInput();
            }
        }

        // ä»è¾“å…¥æ¡†æ·»åŠ æ ‡ç­¾
        function addTagsFromInput() {
            const input = document.getElementById('problem-tags-input');
            const inputValue = input.value.trim();
            
            if (inputValue) {
                const newTags = inputValue.split(/[,ï¼Œ\s]+/).map(tag => tag.trim().toLowerCase()).filter(tag => tag);
                newTags.forEach(tag => {
                    if (tag && !selectedTags.includes(tag) && selectedTags.length < 10) {
                        selectedTags.push(tag);
                    }
                });
                input.value = '';
                updateSelectedTags();
            }
        }

        // æ›´æ–°å·²é€‰æ ‡ç­¾æ˜¾ç¤º
        function updateSelectedTags() {
            const container = document.getElementById('selected-tags');
            container.innerHTML = selectedTags.map(tag => 
                `<span class="tag tag-${getTagClass(tag)}">${tag} <button type="button" onclick="removeTag('${tag}')" style="margin-left: 5px;">&times;</button></span>`
            ).join('');
        }

        // åˆ é™¤æ ‡ç­¾
        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            updateSelectedTags();
        }

        // ç¼–è¾‘æ¨¡å¼æ ‡ç­¾å¤„ç†
        function handleEditTagKeydown(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                addEditTagsFromInput();
            }
        }

        function addEditTagsFromInput() {
            const input = document.getElementById('edit-problem-tags-input');
            const inputValue = input.value.trim();
            
            if (inputValue) {
                const newTags = inputValue.split(/[,ï¼Œ\s]+/).map(tag => tag.trim().toLowerCase()).filter(tag => tag);
                newTags.forEach(tag => {
                    if (tag && !editSelectedTags.includes(tag) && editSelectedTags.length < 10) {
                        editSelectedTags.push(tag);
                    }
                });
                input.value = '';
                updateEditSelectedTags();
            }
        }

        function updateEditSelectedTags() {
            const container = document.getElementById('edit-selected-tags');
            container.innerHTML = editSelectedTags.map(tag => 
                `<span class="tag tag-${getTagClass(tag)}">${tag} <button type="button" onclick="removeEditTag('${tag}')" style="margin-left: 5px;">&times;</button></span>`
            ).join('');
        }

        function removeEditTag(tag) {
            editSelectedTags = editSelectedTags.filter(t => t !== tag);
            updateEditSelectedTags();
        }

        // æ¸²æŸ“é¢˜ç›®è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('problems-table-body');
            const noProblems = document.getElementById('no-problems');
            
            if (currentProblems.length === 0) {
                tbody.innerHTML = '';
                noProblems.classList.remove('hidden');
                document.getElementById('problem-count').textContent = 'å…± 0 é“é¢˜ç›®';
                return;
            }

            noProblems.classList.add('hidden');
            document.getElementById('problem-count').textContent = `å…± ${currentProblems.length} é“é¢˜ç›®`;

            // åˆ†é¡µ
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProblems = currentProblems.slice(startIndex, endIndex);

            tbody.innerHTML = pageProblems.map(problem => `
                <tr>
                    <td>
                        <div class="font-weight-500">${escapeHtml(problem.title)}</div>
                        ${problem.problemIndex ? `<div class="text-gray-500 text-sm">${escapeHtml(problem.problemIndex)}</div>` : ''}
                    </td>
                    <td>
                        <span class="tag">${escapeHtml(problem.platform)}</span>
                    </td>
                    <td>
                        ${problem.difficulty ? 
                            `<span class="difficulty-indicator difficulty-${Math.floor(problem.difficulty/200)*200}">${problem.difficulty}</span>` : 
                            '-'}
                    </td>
                    <td>
                        ${problem.status === 'solved' ? 
                            '<span class="status-badge status-solved">âœ… å·²è§£å†³</span>' : 
                            '<span class="status-badge status-todo">âŒ æœªè§£å†³</span>'}
                    </td>
                    <td>
                        <div class="tags-container">
                            ${(problem.tags || []).slice(0, 3).map(tag => 
                                `<span class="tag tag-${getTagClass(tag)}">${escapeHtml(tag)}</span>`
                            ).join('')}
                            ${problem.tags && problem.tags.length > 3 ? 
                                `<span class="tag">+${problem.tags.length - 3}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewProblemDetail('${problem.id}')">è¯¦æƒ…</button>
                            <button class="btn btn-sm btn-outline" onclick="editProblem('${problem.id}')">ç¼–è¾‘</button>
                            ${problem.status !== 'solved' ? 
                                `<button class="btn btn-sm btn-success" onclick="markAsSolved('${problem.id}')">âœ…</button>` :
                                `<button class="btn btn-sm btn-secondary" onclick="markAsUnsolved('${problem.id}')">âŒ</button>`
                            }
                            <button class="btn btn-sm btn-danger" onclick="deleteProblem('${problem.id}')">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updatePagination();
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const totalPages = Math.ceil(currentProblems.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            
            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
        }

        // ç¿»é¡µ
        function changePage(delta) {
            const totalPages = Math.ceil(currentProblems.length / itemsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(fileInput, folder) {
            const file = fileInput.files[0];
            if (file) {
                // ç”Ÿæˆæ ‡å‡†åŒ–æ–‡ä»¶å
                const sanitizedName = file.name.replace(/[^\w\-\.]/g, '_');
                const relativePath = `./files/${folder}/${sanitizedName}`;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿å­˜æŒ‡å¯¼
                const fullPath = `/home/zyn/program/2025-Summer/ACM-Transit/Context-Engineering-Intro/acm-transit/files/${folder}/${sanitizedName}`;
                
                showFileUploadGuide(file.name, sanitizedName, fullPath, folder);
                
                return relativePath;
            }
            return '';
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ æŒ‡å¯¼
        function showFileUploadGuide(originalName, sanitizedName, fullPath, folder) {
            const message = `
æ–‡ä»¶ä¸Šä¼ æŒ‡å¯¼ï¼š
\nåŸæ–‡ä»¶å: ${originalName}
æ ‡å‡†åŒ–åç§°: ${sanitizedName}
\nè¯·æ‰‹åŠ¨å°†æ–‡ä»¶å¤åˆ¶åˆ°ï¼š
${fullPath}
\næˆ–è€…ä½¿ç”¨å‘½ä»¤ï¼š
cp â€œæ–‡ä»¶è·¯å¾„â€ â€œ${fullPath}â€
\næ–‡ä»¶å·²ç™»è®°åˆ°ç³»ç»Ÿä¸­ï¼Œä½†éœ€è¦æ‚¨æ‰‹åŠ¨æ”¾ç½®æ–‡ä»¶æ‰èƒ½æ­£å¸¸è®¿é—®ã€‚
            `;
            
            if (confirm(message + '\n\nç‚¹å‡»ç¡®å®šç»§ç»­ï¼Œå–æ¶ˆåˆ™ä¸ä¿å­˜æ–‡ä»¶è·¯å¾„ã€‚')) {
                console.log('æ–‡ä»¶ä¸Šä¼ æŒ‡å¯¼:', { originalName, sanitizedName, fullPath, folder });
                return true;
            }
            return false;
        }

        // å¤„ç†é¢˜ç›®æäº¤
        function handleSubmitProblem(event) {
            event.preventDefault();
            
            try {
                const formData = {
                    title: document.getElementById('problem-title').value,
                    platform: document.getElementById('problem-platform').value,
                    difficulty: document.getElementById('problem-difficulty').value,
                    status: document.getElementById('problem-status').value,
                    problemIndex: document.getElementById('problem-index').value,
                    url: document.getElementById('problem-url').value,
                    contestId: document.getElementById('problem-contest').value,
                    pdfPath: handleFileUpload(document.getElementById('problem-pdf-file'), 'contest-pdfs'),
                    tags: selectedTags,
                    notes: document.getElementById('problem-notes').value
                };

                problemManager.addProblem(formData);
                resetForm();
                
            } catch (error) {
                showNotification('æ·»åŠ é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('problem-form').reset();
            selectedTags = [];
            updateSelectedTags();
            document.getElementById('problem-status').value = 'unsolved';
        }

        // æ‰“å¼€é¢˜è§£ç®¡ç†å™¨
        function openSolutionManager(problemId = null) {
            // å¦‚æœæ²¡æœ‰æŒ‡å®šproblemIdï¼Œå°è¯•ä»å½“å‰ç¼–è¾‘çš„é¢˜ç›®è·å–
            if (!problemId) {
                const urlParams = new URLSearchParams(window.location.search);
                problemId = urlParams.get('edit');
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œæç¤ºç”¨æˆ·å…ˆä¿å­˜é¢˜ç›®
            if (!problemId) {
                if (confirm('è¯·å…ˆä¿å­˜é¢˜ç›®ï¼Œç„¶åå†ç®¡ç†é¢˜è§£æ–‡ä»¶ã€‚æ˜¯å¦ç°åœ¨ä¿å­˜é¢˜ç›®ï¼Ÿ')) {
                    // å°è¯•æäº¤è¡¨å•
                    const form = document.getElementById('problem-form');
                    if (form.checkValidity()) {
                        handleSubmitProblem(new Event('submit'));
                        return;
                    } else {
                        alert('è¯·å…ˆå¡«å†™å®Œæ•´çš„é¢˜ç›®ä¿¡æ¯');
                        return;
                    }
                }
                return;
            }
            
            // ä¿å­˜å½“å‰é¢˜ç›®IDåˆ°localStorage
            localStorage.setItem('current-problem-id', problemId);
            
            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€é¢˜è§£ç®¡ç†å™¨
            const managerWindow = window.open(
                `solution-manager.html?problemId=${encodeURIComponent(problemId)}`,
                'solution-manager',
                'width=1000,height=800,scrollbars=yes,resizable=yes'
            );
            
            if (!managerWindow) {
                alert('æ— æ³•æ‰“å¼€é¢˜è§£ç®¡ç†å™¨çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨çš„å¼¹çª—è®¾ç½®');
            }
        }

        // é˜²æŠ–æœç´¢å¤„ç†
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            try {
                const query = document.getElementById('search-query')?.value || '';
                const platform = document.getElementById('filter-platform')?.value || '';
                const status = document.getElementById('filter-status')?.value || '';
                const selectedTag = document.getElementById('filter-tags')?.value || '';
                const minDifficulty = document.getElementById('min-difficulty')?.value || '';
                const maxDifficulty = document.getElementById('max-difficulty')?.value || '';
                
                console.log('æ‰§è¡Œæœç´¢ï¼Œæ¡ä»¶:', { query, platform, status, selectedTag, minDifficulty, maxDifficulty });
                
                const criteria = {};
                if (query.trim()) criteria.search = query.trim();
                if (platform) criteria.platform = platform;
                if (status) criteria.status = status;
                if (selectedTag) criteria.tags = [selectedTag];
                if (minDifficulty) criteria.minDifficulty = parseInt(minDifficulty);
                if (maxDifficulty) criteria.maxDifficulty = parseInt(maxDifficulty);
                
                currentProblems = problemManager.filterProblems(criteria);
                console.log('æœç´¢ç»“æœ:', currentProblems.length, 'é“é¢˜ç›®');
                
                applySorting();
                currentPage = 1;
                renderTable();
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showNotification('æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ’åºå¤„ç†
        function handleSort() {
            const sortBy = document.getElementById('sort-by').value;
            currentSort.field = sortBy;
            applySorting();
            renderTable();
        }

        // è¡¨æ ¼æ’åº
        function handleTableSort(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'desc';
            }
            
            applySorting();
            renderTable();
        }

        // åº”ç”¨æ’åº - ä¿®å¤ç‰ˆæœ¬ï¼šå¯¹å·²ç­›é€‰çš„ç»“æœè¿›è¡Œæ’åº
        function applySorting() {
            if (currentProblems && currentProblems.length > 0) {
                // å¯¹å½“å‰ç­›é€‰ç»“æœè¿›è¡Œæ’åº
                currentProblems.sort((a, b) => {
                    let aValue = a[currentSort.field];
                    let bValue = b[currentSort.field];

                    // å¤„ç†æ—¥æœŸç±»å‹
                    if (currentSort.field === 'addedTime' || currentSort.field === 'solvedTime') {
                        aValue = aValue ? new Date(aValue) : new Date(0);
                        bValue = bValue ? new Date(bValue) : new Date(0);
                    }

                    // å¤„ç†æ•°å­—ç±»å‹ï¼ˆéš¾åº¦ï¼‰
                    if (currentSort.field === 'difficulty') {
                        aValue = aValue || 0;
                        bValue = bValue || 0;
                    }

                    // å¤„ç†å­—ç¬¦ä¸²ç±»å‹
                    if (typeof aValue === 'string' && typeof bValue === 'string') {
                        const result = aValue.localeCompare(bValue, 'zh-CN');
                        return currentSort.order === 'desc' ? -result : result;
                    }

                    // å¤„ç†æ•°å­—å’Œæ—¥æœŸç±»å‹
                    if (aValue < bValue) return currentSort.order === 'desc' ? 1 : -1;
                    if (aValue > bValue) return currentSort.order === 'desc' ? -1 : 1;
                    return 0;
                });
            }
        }

        // æ¸…ç©ºç­›é€‰
        function clearFilters() {
            try {
                document.getElementById('search-query').value = '';
                document.getElementById('filter-platform').value = '';
                document.getElementById('filter-status').value = '';
                document.getElementById('filter-tags').value = '';
                document.getElementById('min-difficulty').value = '';
                document.getElementById('max-difficulty').value = '';
                document.getElementById('sort-by').value = 'addedTime';
                
                // é‡æ–°è·å–æ‰€æœ‰é¢˜ç›®
                currentProblems = problemManager.getAllProblems();
                currentSort = { field: 'addedTime', order: 'desc' };
                applySorting();
                currentPage = 1;
                renderTable();
                
                console.log('ç­›é€‰å·²æ¸…ç©ºï¼Œæ˜¾ç¤º', currentProblems.length, 'é“é¢˜ç›®');
            } catch (error) {
                console.error('æ¸…ç©ºç­›é€‰å¤±è´¥:', error);
                showNotification('æ¸…ç©ºç­›é€‰å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…é¡µé¢
        function viewProblemDetail(id) {
            window.location.href = `problem-detail.html?id=${id}`;
        }

        // ç¼–è¾‘é¢˜ç›®
        function editProblem(id) {
            const problem = problemManager.findProblemById(id);
            if (!problem) {
                showNotification('æ‰¾ä¸åˆ°æŒ‡å®šçš„é¢˜ç›®è®°å½•', 'error');
                return;
            }

            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('edit-problem-id').value = problem.id;
            document.getElementById('edit-problem-title').value = problem.title;
            document.getElementById('edit-problem-platform').value = problem.platform;
            document.getElementById('edit-problem-difficulty').value = problem.difficulty || '';
            document.getElementById('edit-problem-status').value = problem.status;
            document.getElementById('edit-problem-notes').value = problem.notes || '';

            // è®¾ç½®ç¼–è¾‘æ ‡ç­¾
            editSelectedTags = [...(problem.tags || [])];
            updateEditSelectedTags();

            document.getElementById('edit-modal').classList.add('show');
        }

        // å¤„ç†é¢˜ç›®æ›´æ–°
        function handleUpdateProblem(event) {
            event.preventDefault();
            
            try {
                const id = document.getElementById('edit-problem-id').value;
                const updates = {
                    title: document.getElementById('edit-problem-title').value,
                    platform: document.getElementById('edit-problem-platform').value,
                    difficulty: document.getElementById('edit-problem-difficulty').value,
                    status: document.getElementById('edit-problem-status').value,
                    tags: editSelectedTags,
                    notes: document.getElementById('edit-problem-notes').value
                };

                problemManager.updateProblem(id, updates);
                closeEditModal();
                
            } catch (error) {
                showNotification('æ›´æ–°é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            editSelectedTags = [];
        }

        // æ ‡è®°ä¸ºå·²è§£å†³
        function markAsSolved(id) {
            try {
                problemManager.updateProblem(id, { status: 'solved' });
            } catch (error) {
                showNotification('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ ‡è®°ä¸ºæœªè§£å†³
        function markAsUnsolved(id) {
            try {
                problemManager.updateProblem(id, { status: 'unsolved' });
            } catch (error) {
                showNotification('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤é¢˜ç›®
        function deleteProblem(id) {
            const problem = problemManager.findProblemById(id);
            if (!problem) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤é¢˜ç›® "${problem.title}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                try {
                    problemManager.deleteProblem(id);
                } catch (error) {
                    showNotification('åˆ é™¤é¢˜ç›®å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // å¯¼å‡ºé¢˜ç›®æ•°æ®
        async function exportProblems() {
            try {
                const success = await problemManager.exportProblems('problems-export.json');
                if (success) {
                    showNotification('é¢˜ç›®æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
                }
            } catch (error) {
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å…¥é¢˜ç›®æ•°æ®
        async function importProblems() {
            try {
                const data = await storage.importData();
                if (data) {
                    const result = await problemManager.importProblems(data);
                    showNotification(`å¯¼å…¥æˆåŠŸï¼šæ–°å¢ ${result.addedCount} é“é¢˜ç›®`, 'success');
                }
            } catch (error) {
                showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                await problemManager.reloadData();
                await loadData();
                showNotification('æ•°æ®åˆ·æ–°æˆåŠŸ', 'success');
            } catch (error) {
                showNotification('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function getTagClass(tag) {
            const tagClasses = {
                'dp': 'dp',
                'greedy': 'greedy', 
                'graph': 'graph',
                'math': 'math',
                'string': 'string'
            };
            return tagClasses[tag] || 'default';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            if (storage && storage.showNotification) {
                storage.showNotification(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
    </script>
</body>
</html>