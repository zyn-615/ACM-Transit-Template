<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表板 - ACM中转站</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ACM中转站</a>
            <ul class="navbar-nav">
                <li><a href="index.html" class="active">仪表板</a></li>
                <li><a href="contests.html">比赛管理</a></li>
                <li><a href="problems.html">题目管理</a></li>
            </ul>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="main-content">
        <!-- 页面标题 -->
        <div class="page-header">
            <h1 class="page-title">欢迎使用ACM中转站</h1>
            <p class="page-subtitle">一站式管理你的竞赛记录和题目进度</p>
        </div>

        <!-- 快速操作按钮 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">快速操作</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="showAppInfo()">系统信息</button>
                    <button class="btn btn-secondary btn-sm" onclick="syncAllData()">同步数据</button>
                </div>
            </div>
            <div class="btn-group">
                <a href="contests.html" class="btn btn-primary">添加比赛记录</a>
                <a href="problems.html" class="btn btn-success">添加题目记录</a>
                <button class="btn btn-outline" onclick="exportAllData()">导出所有数据</button>
                <button class="btn btn-outline" onclick="importAllData()">导入数据</button>
            </div>
        </div>

        <!-- 总体统计 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-contests">0</div>
                <div class="stat-label">总比赛数</div>
                <div class="stat-change" id="contests-change">新增 0 场</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-problems">0</div>
                <div class="stat-label">总题目数</div>
                <div class="stat-change" id="problems-change">新增 0 道</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="solved-problems">0</div>
                <div class="stat-label">已解决题目</div>
                <div class="stat-change" id="solve-rate">解决率 0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-rank">-</div>
                <div class="stat-label">平均排名</div>
                <div class="stat-change" id="rank-trend">-</div>
            </div>
        </div>

        <!-- 活动概览 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="this-month-contests">0</div>
                <div class="stat-label">本月比赛</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="this-week-solved">0</div>
                <div class="stat-label">本周解题</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-difficulty">-</div>
                <div class="stat-label">平均难度</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-days">0</div>
                <div class="stat-label">活跃天数</div>
            </div>
        </div>

        <!-- 最近活动 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">最近活动</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="refreshData()">刷新</button>
                </div>
            </div>
            
            <!-- 最近比赛 -->
            <div class="mb-4">
                <h3 class="text-lg font-weight-600 mb-2">最近比赛</h3>
                <div id="recent-contests">
                    <div class="text-center text-gray-500 p-4">
                        <p>暂无比赛记录</p>
                        <a href="contests.html" class="btn btn-primary btn-sm mt-2">添加第一场比赛</a>
                    </div>
                </div>
            </div>

            <!-- 最近题目 -->
            <div class="mb-4">
                <h3 class="text-lg font-weight-600 mb-2">最近解决的题目</h3>
                <div id="recent-problems">
                    <div class="text-center text-gray-500 p-4">
                        <p>暂无题目记录</p>
                        <a href="problems.html" class="btn btn-success btn-sm mt-2">添加第一道题目</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 平台分布 -->
        <div class="stats-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">比赛平台分布</h3>
                </div>
                <div id="contest-platforms">
                    <div class="text-center text-gray-500 p-4">暂无数据</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">题目标签分布</h3>
                </div>
                <div id="problem-tags">
                    <div class="text-center text-gray-500 p-4">暂无数据</div>
                </div>
            </div>
        </div>

        <!-- 进度图表 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">月度进度</h2>
            </div>
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-500" id="current-month-contests">0</div>
                        <div class="text-sm text-gray-500">本月比赛</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-500" id="current-month-problems">0</div>
                        <div class="text-sm text-gray-500">本月解题</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-500" id="streak-days">0</div>
                        <div class="text-sm text-gray-500">连续天数</div>
                    </div>
                </div>
                <div id="monthly-chart" class="text-center text-gray-500">
                    <p>图表功能待实现</p>
                </div>
            </div>
        </div>

        <!-- 推荐和目标 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">推荐与目标</h2>
            </div>
            <div class="p-4">
                <div id="recommendations">
                    <!-- 动态生成推荐内容 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 系统信息模态框 -->
    <div id="app-info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">系统信息</h3>
                <button class="modal-close" onclick="closeAppInfoModal()">&times;</button>
            </div>
            <div class="modal-body" id="app-info-content">
                <!-- 动态填充系统信息 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAppInfoModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 加载JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/contests.js"></script>
    <script src="js/problems.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // 仪表板页面控制脚本 - 使用 DashboardManager
        let dashboardManager = null;

        // 等待应用程序初始化完成
        document.addEventListener('acm-appInitialized', function(event) {
            console.log('仪表板：应用程序初始化完成');
            initializeDashboard();
        });

        // 如果应用已经初始化，直接初始化仪表板
        setTimeout(() => {
            if (window.ACMTransit && window.ACMTransit.initialized) {
                initializeDashboard();
            }
        }, 1000);

        // 初始化仪表板
        function initializeDashboard() {
            try {
                const app = window.ACMTransit;
                if (!app || !app.initialized) {
                    console.log('等待应用程序初始化...');
                    return;
                }

                // 获取 DashboardManager 实例
                dashboardManager = app.dashboardManager;
                
                if (!dashboardManager) {
                    console.warn('DashboardManager 未找到，可能是页面类型不匹配');
                    return;
                }

                // 如果已经初始化，直接更新UI；否则等待初始化完成
                if (dashboardManager.initialized) {
                    updateDashboardUI();
                } else {
                    dashboardManager.on('initialized', updateDashboardUI);
                }

                // 监听数据更新事件
                dashboardManager.on('dataRefreshed', updateDashboardUI);
                
            } catch (error) {
                console.error('初始化仪表板失败:', error);
                showNotification('初始化失败: ' + error.message, 'error');
            }
        }

        // 更新仪表板UI
        function updateDashboardUI() {
            try {
                if (!dashboardManager || !dashboardManager.initialized) {
                    console.warn('DashboardManager 未准备好');
                    return;
                }

                console.log('更新仪表板UI');
                
                // DashboardManager 的 renderDashboard() 方法会自动更新所有UI元素
                // 这里我们只需要处理一些额外的UI更新
                
                // 更新页面标题状态
                updatePageStatus();
                
            } catch (error) {
                console.error('更新仪表板UI失败:', error);
                showNotification('更新界面失败: ' + error.message, 'error');
            }
        }

        // 更新页面状态信息
        function updatePageStatus() {
            const stats = dashboardManager.getStatistics();
            if (!stats) return;

            // 更新页面副标题以显示数据状态
            const subtitle = document.querySelector('.page-subtitle');
            if (subtitle && stats.lastUpdated) {
                const updateTime = new Date(stats.lastUpdated).toLocaleTimeString('zh-CN');
                subtitle.textContent = `一站式管理你的竞赛记录和题目进度 • 最后更新: ${updateTime}`;
            }
        }

        // 显示系统信息
        function showAppInfo() {
            const app = window.ACMTransit;
            if (!app) {
                alert('应用程序未初始化');
                return;
            }

            const info = app.getAppInfo();
            const stats = dashboardManager ? dashboardManager.getStatistics() : null;
            const content = document.getElementById('app-info-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-weight-600">应用信息</h4>
                        <p>名称: ${info.name}</p>
                        <p>版本: ${info.version}</p>
                        <p>当前页面: ${info.currentPage}</p>
                        <p>初始化状态: ${info.initialized ? '已完成' : '进行中'}</p>
                    </div>
                    <div>
                        <h4 class="font-weight-600">功能支持</h4>
                        <p>本地存储: ${info.features.localStorage ? '✅ 支持' : '❌ 不支持'}</p>
                        <p>文件系统访问: ${info.features.fileSystemAccess ? '✅ 支持' : '❌ 不支持'}</p>
                        <p>网络状态: ${info.features.offline ? '🔴 离线' : '🟢 在线'}</p>
                    </div>
                    <div>
                        <h4 class="font-weight-600">管理器状态</h4>
                        <p>存储管理器: ${info.managers.storage ? '✅ 已加载' : '❌ 未加载'}</p>
                        <p>仪表板管理器: ${dashboardManager ? '✅ 已加载' : '❌ 未加载'}</p>
                        <p>DashboardManager初始化: ${dashboardManager && dashboardManager.initialized ? '✅ 完成' : '❌ 未完成'}</p>
                    </div>
                    ${stats ? `
                    <div>
                        <h4 class="font-weight-600">数据统计</h4>
                        <p>比赛记录: ${stats.contests.total} 条</p>
                        <p>题目记录: ${stats.problems.total} 条</p>
                        <p>已解决题目: ${stats.problems.solved} 道</p>
                        <p>上次更新: ${new Date(stats.lastUpdated).toLocaleString('zh-CN')}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('app-info-modal').classList.add('show');
        }

        // 关闭系统信息模态框
        function closeAppInfoModal() {
            document.getElementById('app-info-modal').classList.remove('show');
        }

        // 同步所有数据
        async function syncAllData() {
            const app = window.ACMTransit;
            if (app && app.syncData) {
                await app.syncData();
            }
        }

        // 导出所有数据
        async function exportAllData() {
            try {
                const app = window.ACMTransit;
                if (!app || !app.storage) {
                    throw new Error('存储管理器未初始化');
                }

                if (!dashboardManager) {
                    throw new Error('仪表板管理器未初始化');
                }

                const stats = dashboardManager.getStatistics();
                const allData = {
                    contests: dashboardManager.contests,
                    problems: dashboardManager.problems,
                    statistics: stats,
                    exportTime: new Date().toISOString(),
                    version: '1.0'
                };

                const dateString = new Date().toISOString().split('T')[0];
                const success = await app.storage.exportData(allData, `acm-transit-backup-${dateString}.json`);
                if (success) {
                    showNotification('数据导出成功', 'success');
                }
            } catch (error) {
                showNotification('导出失败: ' + error.message, 'error');
            }
        }

        // 导入数据
        async function importAllData() {
            try {
                const app = window.ACMTransit;
                if (!app || !app.storage) {
                    throw new Error('存储管理器未初始化');
                }

                const data = await app.storage.importData();
                if (data) {
                    showNotification('数据导入成功，正在刷新...', 'success');
                    // 刷新仪表板数据
                    if (dashboardManager) {
                        await dashboardManager.refreshData();
                    }
                }
            } catch (error) {
                showNotification('导入失败: ' + error.message, 'error');
            }
        }

        // 刷新数据
        async function refreshData() {
            try {
                if (dashboardManager) {
                    await dashboardManager.refreshData();
                    showNotification('数据已刷新', 'success');
                } else {
                    showNotification('仪表板管理器未准备好', 'warning');
                }
            } catch (error) {
                showNotification('刷新失败: ' + error.message, 'error');
            }
        }

        // 工具函数
        function showNotification(message, type = 'info') {
            const app = window.ACMTransit;
            if (app && app.showGlobalMessage) {
                app.showGlobalMessage(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // 模态框点击外部关闭
        document.getElementById('app-info-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAppInfoModal();
            }
        });
    </script>
</body>
</html>