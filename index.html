<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨æ¿ - ACMä¸­è½¬ç«™</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ACMä¸­è½¬ç«™</a>
            <ul class="navbar-nav">
                <li><a href="index.html" class="active">ä»ªè¡¨æ¿</a></li>
                <li><a href="contests.html">æ¯”èµ›ç®¡ç†</a></li>
                <li><a href="problems.html">é¢˜ç›®ç®¡ç†</a></li>
            </ul>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h1 class="page-title">æ¬¢è¿ä½¿ç”¨ACMä¸­è½¬ç«™</h1>
            <p class="page-subtitle">ä¸€ç«™å¼ç®¡ç†ä½ çš„ç«èµ›è®°å½•å’Œé¢˜ç›®è¿›åº¦</p>
        </div>

        <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">å¿«é€Ÿæ“ä½œ</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="showAppInfo()">ç³»ç»Ÿä¿¡æ¯</button>
                    <button class="btn btn-secondary btn-sm" onclick="syncAllData()">åŒæ­¥æ•°æ®</button>
                </div>
            </div>
            <div class="btn-group">
                <a href="contests.html" class="btn btn-primary">æ·»åŠ æ¯”èµ›è®°å½•</a>
                <a href="problems.html" class="btn btn-success">æ·»åŠ é¢˜ç›®è®°å½•</a>
                <button class="btn btn-outline" onclick="exportAllData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-outline" onclick="importAllData()">å¯¼å…¥æ•°æ®</button>
            </div>
        </div>

        <!-- æ€»ä½“ç»Ÿè®¡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-contests">0</div>
                <div class="stat-label">æ€»æ¯”èµ›æ•°</div>
                <div class="stat-change" id="contests-change">æ–°å¢ 0 åœº</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-problems">0</div>
                <div class="stat-label">æ€»é¢˜ç›®æ•°</div>
                <div class="stat-change" id="problems-change">æ–°å¢ 0 é“</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="solved-problems">0</div>
                <div class="stat-label">å·²è§£å†³é¢˜ç›®</div>
                <div class="stat-change" id="solve-rate">è§£å†³ç‡ 0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-rank">-</div>
                <div class="stat-label">å¹³å‡æ’å</div>
                <div class="stat-change" id="rank-trend">-</div>
            </div>
        </div>

        <!-- æ´»åŠ¨æ¦‚è§ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="this-month-contests">0</div>
                <div class="stat-label">æœ¬æœˆæ¯”èµ›</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="this-week-solved">0</div>
                <div class="stat-label">æœ¬å‘¨è§£é¢˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-difficulty">-</div>
                <div class="stat-label">å¹³å‡éš¾åº¦</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-days">0</div>
                <div class="stat-label">æ´»è·ƒå¤©æ•°</div>
            </div>
        </div>

        <!-- æœ€è¿‘æ´»åŠ¨ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æœ€è¿‘æ´»åŠ¨</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="refreshData()">åˆ·æ–°</button>
                </div>
            </div>
            
            <!-- æœ€è¿‘æ¯”èµ› -->
            <div class="mb-4">
                <h3 class="text-lg font-weight-600 mb-2">æœ€è¿‘æ¯”èµ›</h3>
                <div id="recent-contests">
                    <div class="text-center text-gray-500 p-4">
                        <p>æš‚æ— æ¯”èµ›è®°å½•</p>
                        <a href="contests.html" class="btn btn-primary btn-sm mt-2">æ·»åŠ ç¬¬ä¸€åœºæ¯”èµ›</a>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘é¢˜ç›® -->
            <div class="mb-4">
                <h3 class="text-lg font-weight-600 mb-2">æœ€è¿‘è§£å†³çš„é¢˜ç›®</h3>
                <div id="recent-problems">
                    <div class="text-center text-gray-500 p-4">
                        <p>æš‚æ— é¢˜ç›®è®°å½•</p>
                        <a href="problems.html" class="btn btn-success btn-sm mt-2">æ·»åŠ ç¬¬ä¸€é“é¢˜ç›®</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¹³å°åˆ†å¸ƒ -->
        <div class="stats-grid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">æ¯”èµ›å¹³å°åˆ†å¸ƒ</h3>
                </div>
                <div id="contest-platforms">
                    <div class="text-center text-gray-500 p-4">æš‚æ— æ•°æ®</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">é¢˜ç›®æ ‡ç­¾åˆ†å¸ƒ</h3>
                </div>
                <div id="problem-tags">
                    <div class="text-center text-gray-500 p-4">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦å›¾è¡¨ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æœˆåº¦è¿›åº¦</h2>
            </div>
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-500" id="current-month-contests">0</div>
                        <div class="text-sm text-gray-500">æœ¬æœˆæ¯”èµ›</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-500" id="current-month-problems">0</div>
                        <div class="text-sm text-gray-500">æœ¬æœˆè§£é¢˜</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-500" id="streak-days">0</div>
                        <div class="text-sm text-gray-500">è¿ç»­å¤©æ•°</div>
                    </div>
                </div>
                <div id="monthly-chart" class="text-center text-gray-500">
                    <p>å›¾è¡¨åŠŸèƒ½å¾…å®ç°</p>
                </div>
            </div>
        </div>

        <!-- æ¨èå’Œç›®æ ‡ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æ¨èä¸ç›®æ ‡</h2>
            </div>
            <div class="p-4">
                <div id="recommendations">
                    <!-- åŠ¨æ€ç”Ÿæˆæ¨èå†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="app-info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç³»ç»Ÿä¿¡æ¯</h3>
                <button class="modal-close" onclick="closeAppInfoModal()">&times;</button>
            </div>
            <div class="modal-body" id="app-info-content">
                <!-- åŠ¨æ€å¡«å……ç³»ç»Ÿä¿¡æ¯ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAppInfoModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/contests.js"></script>
    <script src="js/problems.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/main.js"></script>
    
    <script>
        // ä»ªè¡¨æ¿é¡µé¢æ§åˆ¶è„šæœ¬ - ä½¿ç”¨ DashboardManager
        let dashboardManager = null;

        // ç­‰å¾…åº”ç”¨ç¨‹åºåˆå§‹åŒ–å®Œæˆ
        document.addEventListener('acm-appInitialized', function(event) {
            console.log('ä»ªè¡¨æ¿ï¼šåº”ç”¨ç¨‹åºåˆå§‹åŒ–å®Œæˆ');
            initializeDashboard();
        });

        // å¦‚æœåº”ç”¨å·²ç»åˆå§‹åŒ–ï¼Œç›´æ¥åˆå§‹åŒ–ä»ªè¡¨æ¿
        setTimeout(() => {
            if (window.ACMTransit && window.ACMTransit.initialized) {
                initializeDashboard();
            }
        }, 1000);

        // åˆå§‹åŒ–ä»ªè¡¨æ¿
        function initializeDashboard() {
            try {
                const app = window.ACMTransit;
                if (!app || !app.initialized) {
                    console.log('ç­‰å¾…åº”ç”¨ç¨‹åºåˆå§‹åŒ–...');
                    return;
                }

                // è·å– DashboardManager å®ä¾‹
                dashboardManager = app.dashboardManager;
                
                if (!dashboardManager) {
                    console.warn('DashboardManager æœªæ‰¾åˆ°ï¼Œå¯èƒ½æ˜¯é¡µé¢ç±»å‹ä¸åŒ¹é…');
                    return;
                }

                // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œç›´æ¥æ›´æ–°UIï¼›å¦åˆ™ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                if (dashboardManager.initialized) {
                    updateDashboardUI();
                } else {
                    dashboardManager.on('initialized', updateDashboardUI);
                }

                // ç›‘å¬æ•°æ®æ›´æ–°äº‹ä»¶
                dashboardManager.on('dataRefreshed', updateDashboardUI);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–ä»ªè¡¨æ¿å¤±è´¥:', error);
                showNotification('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ä»ªè¡¨æ¿UI
        function updateDashboardUI() {
            try {
                if (!dashboardManager || !dashboardManager.initialized) {
                    console.warn('DashboardManager æœªå‡†å¤‡å¥½');
                    return;
                }

                console.log('æ›´æ–°ä»ªè¡¨æ¿UI');
                
                // DashboardManager çš„ renderDashboard() æ–¹æ³•ä¼šè‡ªåŠ¨æ›´æ–°æ‰€æœ‰UIå…ƒç´ 
                // è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å¤„ç†ä¸€äº›é¢å¤–çš„UIæ›´æ–°
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜çŠ¶æ€
                updatePageStatus();
                
            } catch (error) {
                console.error('æ›´æ–°ä»ªè¡¨æ¿UIå¤±è´¥:', error);
                showNotification('æ›´æ–°ç•Œé¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é¡µé¢çŠ¶æ€ä¿¡æ¯
        function updatePageStatus() {
            const stats = dashboardManager.getStatistics();
            if (!stats) return;

            // æ›´æ–°é¡µé¢å‰¯æ ‡é¢˜ä»¥æ˜¾ç¤ºæ•°æ®çŠ¶æ€
            const subtitle = document.querySelector('.page-subtitle');
            if (subtitle && stats.lastUpdated) {
                const updateTime = new Date(stats.lastUpdated).toLocaleTimeString('zh-CN');
                subtitle.textContent = `ä¸€ç«™å¼ç®¡ç†ä½ çš„ç«èµ›è®°å½•å’Œé¢˜ç›®è¿›åº¦ â€¢ æœ€åæ›´æ–°: ${updateTime}`;
            }
        }

        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        function showAppInfo() {
            const app = window.ACMTransit;
            if (!app) {
                alert('åº”ç”¨ç¨‹åºæœªåˆå§‹åŒ–');
                return;
            }

            const info = app.getAppInfo();
            const stats = dashboardManager ? dashboardManager.getStatistics() : null;
            const content = document.getElementById('app-info-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-weight-600">åº”ç”¨ä¿¡æ¯</h4>
                        <p>åç§°: ${info.name}</p>
                        <p>ç‰ˆæœ¬: ${info.version}</p>
                        <p>å½“å‰é¡µé¢: ${info.currentPage}</p>
                        <p>åˆå§‹åŒ–çŠ¶æ€: ${info.initialized ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</p>
                    </div>
                    <div>
                        <h4 class="font-weight-600">åŠŸèƒ½æ”¯æŒ</h4>
                        <p>æœ¬åœ°å­˜å‚¨: ${info.features.localStorage ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</p>
                        <p>æ–‡ä»¶ç³»ç»Ÿè®¿é—®: ${info.features.fileSystemAccess ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</p>
                        <p>ç½‘ç»œçŠ¶æ€: ${info.features.offline ? 'ğŸ”´ ç¦»çº¿' : 'ğŸŸ¢ åœ¨çº¿'}</p>
                    </div>
                    <div>
                        <h4 class="font-weight-600">ç®¡ç†å™¨çŠ¶æ€</h4>
                        <p>å­˜å‚¨ç®¡ç†å™¨: ${info.managers.storage ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</p>
                        <p>ä»ªè¡¨æ¿ç®¡ç†å™¨: ${dashboardManager ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}</p>
                        <p>DashboardManageråˆå§‹åŒ–: ${dashboardManager && dashboardManager.initialized ? 'âœ… å®Œæˆ' : 'âŒ æœªå®Œæˆ'}</p>
                    </div>
                    ${stats ? `
                    <div>
                        <h4 class="font-weight-600">æ•°æ®ç»Ÿè®¡</h4>
                        <p>æ¯”èµ›è®°å½•: ${stats.contests.total} æ¡</p>
                        <p>é¢˜ç›®è®°å½•: ${stats.problems.total} æ¡</p>
                        <p>å·²è§£å†³é¢˜ç›®: ${stats.problems.solved} é“</p>
                        <p>ä¸Šæ¬¡æ›´æ–°: ${new Date(stats.lastUpdated).toLocaleString('zh-CN')}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('app-info-modal').classList.add('show');
        }

        // å…³é—­ç³»ç»Ÿä¿¡æ¯æ¨¡æ€æ¡†
        function closeAppInfoModal() {
            document.getElementById('app-info-modal').classList.remove('show');
        }

        // åŒæ­¥æ‰€æœ‰æ•°æ®
        async function syncAllData() {
            const app = window.ACMTransit;
            if (app && app.syncData) {
                await app.syncData();
            }
        }

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        async function exportAllData() {
            try {
                const app = window.ACMTransit;
                if (!app || !app.storage) {
                    throw new Error('å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }

                if (!dashboardManager) {
                    throw new Error('ä»ªè¡¨æ¿ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }

                const stats = dashboardManager.getStatistics();
                const allData = {
                    contests: dashboardManager.contests,
                    problems: dashboardManager.problems,
                    statistics: stats,
                    exportTime: new Date().toISOString(),
                    version: '1.0'
                };

                const dateString = new Date().toISOString().split('T')[0];
                const success = await app.storage.exportData(allData, `acm-transit-backup-${dateString}.json`);
                if (success) {
                    showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
                }
            } catch (error) {
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å…¥æ•°æ®
        async function importAllData() {
            try {
                const app = window.ACMTransit;
                if (!app || !app.storage) {
                    throw new Error('å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                }

                const data = await app.storage.importData();
                if (data) {
                    showNotification('æ•°æ®å¯¼å…¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...', 'success');
                    // åˆ·æ–°ä»ªè¡¨æ¿æ•°æ®
                    if (dashboardManager) {
                        await dashboardManager.refreshData();
                    }
                }
            } catch (error) {
                showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                if (dashboardManager) {
                    await dashboardManager.refreshData();
                    showNotification('æ•°æ®å·²åˆ·æ–°', 'success');
                } else {
                    showNotification('ä»ªè¡¨æ¿ç®¡ç†å™¨æœªå‡†å¤‡å¥½', 'warning');
                }
            } catch (error) {
                showNotification('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function showNotification(message, type = 'info') {
            const app = window.ACMTransit;
            if (app && app.showGlobalMessage) {
                app.showGlobalMessage(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.getElementById('app-info-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAppInfoModal();
            }
        });
    </script>
</body>
</html>