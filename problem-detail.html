<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>题目详情 - ACM中转站</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/solutions.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ACM中转站</a>
            <ul class="navbar-nav">
                <li><a href="index.html">仪表板</a></li>
                <li><a href="contests.html">比赛管理</a></li>
                <li><a href="problems.html">题目管理</a></li>
            </ul>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="main-content">
        <!-- 返回按钮 -->
        <div class="page-header">
            <div class="flex items-center gap-3">
                <button class="btn btn-outline btn-sm" onclick="goBack()">← 返回题目列表</button>
                <div>
                    <h1 class="page-title" id="problem-title">题目详情</h1>
                    <p class="page-subtitle" id="problem-info">加载中...</p>
                </div>
            </div>
        </div>

        <!-- 题目基本信息 -->
        <div class="card" id="problem-details">
            <div class="card-header">
                <h2 class="card-title">题目信息</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="editProblem()">编辑题目</button>
                    <button class="btn btn-sm" id="status-toggle-btn" onclick="toggleStatus()">
                        <!-- 动态设置 -->
                    </button>
                </div>
            </div>
            <div class="form-container">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">题目平台</label>
                        <div class="form-value">
                            <span class="tag" id="problem-platform">-</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">题目编号</label>
                        <div class="form-value" id="problem-index">-</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">难度值</label>
                        <div class="form-value" id="problem-difficulty">-</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">解决状态</label>
                        <div class="form-value" id="problem-status-display">
                            <!-- 动态设置 -->
                        </div>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">题目链接</label>
                        <div class="form-value" id="problem-url-display">
                            <a href="#" id="problem-url-link" target="_blank" style="display: none;">打开题目页面</a>
                            <span id="problem-url-empty">无</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">所属比赛</label>
                        <div class="form-value" id="problem-contest-display">
                            <a href="#" id="problem-contest-link" style="display: none;">查看比赛</a>
                            <span id="problem-contest-empty">无</span>
                        </div>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">题目文件</label>
                        <div class="form-value" id="problem-files-display">
                            <div id="problem-files-container">正在加载文件...</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">题解文件</label>
                        <div class="form-value" id="solution-files-display">
                            <div id="solution-files-container">正在加载题解...</div>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="problem-tags-section" style="display: none;">
                    <label class="form-label">标签</label>
                    <div class="form-value">
                        <div id="problem-tags-display" class="tags-container">
                            <!-- 动态加载标签 -->
                        </div>
                    </div>
                </div>
                <div class="form-group" id="problem-notes-section" style="display: none;">
                    <label class="form-label">备注</label>
                    <div class="form-value" id="problem-notes-display"></div>
                </div>
                <div class="form-group" id="problem-times-section" style="display: none;">
                    <label class="form-label">时间信息</label>
                    <div class="form-value">
                        <div class="time-info">
                            <div>添加时间: <span id="problem-added-time">-</span></div>
                            <div id="problem-solved-time-row" style="display: none;">
                                解决时间: <span id="problem-solved-time">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 题目文件管理 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">📁 题目文件</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="refreshProblemFiles()">🔄 刷新状态</button>
                    <button class="btn btn-primary btn-sm" onclick="showProblemFileUploadGuidance()">📁 上传指导</button>
                </div>
            </div>
            <div class="problem-files-section">
                <div class="files-grid">
                    <div class="file-item">
                        <div class="file-icon">📄</div>
                        <div class="file-info">
                            <h4>题目描述</h4>
                            <div class="file-link" id="problemStatementLink">
                                <span class="status">检查中...</span>
                            </div>
                        </div>
                    </div>
                    <div class="file-item">
                        <div class="file-icon">🏆</div>
                        <div class="file-info">
                            <h4>官方题解</h4>
                            <div class="file-link" id="officialSolutionLink">
                                <span class="status">检查中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 题解作者管理 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">👥 题解作者</h2>
                <div class="card-actions">
                    <button class="btn btn-primary btn-sm" onclick="showAddAuthorModal()">
                        ➕ 添加作者
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="refreshSolutionAuthors()">🔄 刷新</button>
                </div>
            </div>
            <div class="form-container">
                <div id="solution-authors-container">
                    <!-- 题解作者列表将在这里渲染 -->
                </div>
            </div>
        </div>

        <!-- 相关操作 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">快速操作</h2>
            </div>
            <div class="form-container">
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="createSolutionTemplate()">生成题解模板</button>
                    <button class="btn btn-outline" onclick="copyProblemInfo()">复制题目信息</button>
                    <button class="btn btn-outline" onclick="addToCustomContest()">添加到自定义比赛</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载 JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/new-file-manager.js"></script>
    <script src="js/contest-generator.js"></script>
    <script src="js/problems.js"></script>
    <script src="js/contests.js"></script>
    <script src="js/solution-manager.js"></script>
    <script src="js/search.js"></script>
    <script src="js/file-manager.js"></script>
    
    <script>
        // 全局变量
        let storage, problemManager, contestManager, globalSearch, newFileManager;
        let currentProblem = null;
        let problemId = null;

        // 从URL获取题目ID
        function getProblemIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                problemId = getProblemIdFromUrl();
                if (!problemId) {
                    showNotification('未指定题目ID', 'error');
                    goBack();
                    return;
                }

                console.log(`题目详情页面初始化开始，题目ID: ${problemId}`);

                // 显示加载状态
                document.getElementById('problem-title').textContent = '加载中...';
                document.getElementById('problem-info').textContent = '正在获取题目信息';

                // 初始化存储和管理器
                storage = new DataStorage();
                problemManager = new ProblemManager(storage);
                contestManager = new ContestManager(storage);
                newFileManager = new NewFileManager();

                // 初始化全局搜索
                try {
                    globalSearch = new GlobalSearchManager(storage);
                    console.log('全局搜索初始化完成');
                } catch (error) {
                    console.error('初始化全局搜索失败:', error);
                }

                // 等待初始化完成 - 使用改进的等待机制
                await Promise.all([
                    waitForManagerInitialization(problemManager),
                    waitForManagerInitialization(contestManager)
                ]);

                // 设置事件监听器
                setupEventListeners();
                
                // 加载题目数据 - 使用多策略匹配
                await loadProblemData();
                
                // 加载题目文件和作者信息
                await loadProblemFiles();
                await loadSolutionAuthors();
                
                console.log('题目详情页面初始化完成，题目:', currentProblem?.title || '未找到');
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败: ' + error.message, 'error');
                renderErrorState(error.message);
            }
        });

        // 等待管理器初始化的改进方法
        function waitForManagerInitialization(manager) {
            return new Promise((resolve, reject) => {
                if (manager.initialized) {
                    resolve();
                    return;
                }

                const timeout = setTimeout(() => {
                    reject(new Error('Manager initialization timeout'));
                }, 10000);

                const onInitialized = () => {
                    clearTimeout(timeout);
                    manager.off('initialized', onInitialized);
                    resolve();
                };

                manager.on('initialized', onInitialized);
            });
        }

        // 多策略题目查找
        function findProblemById(problemId) {
            const problems = problemManager.problems || [];
            
            // Strategy 1: Direct ID match
            let problem = problems.find(p => p.id === problemId);
            
            if (!problem) {
                // Strategy 2: Contest-generated pattern match
                problem = problems.find(p => {
                    return p.contestId && p.problemLetter && 
                           `${p.contestId}-${p.problemLetter.toLowerCase()}` === problemId;
                });
            }
            
            if (!problem) {
                // Strategy 3: Partial ID match for legacy compatibility
                problem = problems.find(p => 
                    p.id.includes(problemId) || problemId.includes(p.id)
                );
            }
            
            if (!problem) {
                // Strategy 4: Title-based fallback
                problem = problems.find(p => 
                    p.title === problemId || p.title.includes(problemId)
                );
            }
            
            if (!problem) {
                console.warn(`Problem not found: ${problemId}`);
                console.log('Available problems:', problems.map(p => ({ 
                    id: p.id, 
                    title: p.title, 
                    contestId: p.contestId, 
                    problemLetter: p.problemLetter 
                })));
            }
            
            return problem;
        }

        // 设置事件监听器
        function setupEventListeners() {
            problemManager.on('problemUpdated', () => {
                loadProblemData();
                showNotification('题目更新成功', 'success');
            });
        }

        // 加载题目数据
        async function loadProblemData() {
            try {
                // 使用多策略匹配查找题目
                currentProblem = findProblemById(problemId);
                if (!currentProblem) {
                    throw new Error(`Problem with ID '${problemId}' not found`);
                }

                updateProblemInfo();
            } catch (error) {
                console.error('加载题目数据失败:', error);
                showNotification('加载数据失败: ' + error.message, 'error');
                renderErrorState(error.message);
            }
        }

        // 渲染错误状态
        function renderErrorState(message) {
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="page-header">
                        <div class="flex items-center gap-3">
                            <button class="btn btn-outline btn-sm" onclick="goBack()">← 返回题目列表</button>
                            <div>
                                <h1 class="page-title">页面加载失败</h1>
                                <p class="page-subtitle">无法初始化题目详情页面</p>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="error-state text-center">
                                <h3>⚠️ 题目加载失败</h3>
                                <p class="text-gray-600 mb-4">${escapeHtml(message)}</p>
                                <div class="btn-group">
                                    <button onclick="location.reload()" class="btn btn-primary">重新加载</button>
                                    <button onclick="goBack()" class="btn btn-outline">返回列表</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 更新题目信息显示
        async function updateProblemInfo() {
            document.getElementById('problem-title').textContent = currentProblem.title;
            document.getElementById('problem-info').textContent = 
                `${currentProblem.platform}${currentProblem.problemIndex ? ' • ' + currentProblem.problemIndex : ''}`;
            
            document.getElementById('problem-platform').textContent = currentProblem.platform;
            document.getElementById('problem-index').textContent = currentProblem.problemIndex || '无';
            
            // 难度显示
            if (currentProblem.difficulty) {
                document.getElementById('problem-difficulty').innerHTML = 
                    `<span class="difficulty-indicator difficulty-${Math.floor(currentProblem.difficulty/200)*200}">${currentProblem.difficulty}</span>`;
            } else {
                document.getElementById('problem-difficulty').textContent = '无';
            }

            // 状态显示
            const statusDisplay = document.getElementById('problem-status-display');
            const statusToggleBtn = document.getElementById('status-toggle-btn');
            if (currentProblem.status === 'solved') {
                statusDisplay.innerHTML = '<span class="status-badge status-solved">✅ 已解决</span>';
                statusToggleBtn.innerHTML = '❌ 标记为未解决';
                statusToggleBtn.className = 'btn btn-sm btn-secondary';
            } else {
                statusDisplay.innerHTML = '<span class="status-badge status-todo">❌ 未解决</span>';
                statusToggleBtn.innerHTML = '✅ 标记为已解决';
                statusToggleBtn.className = 'btn btn-sm btn-success';
            }

            // 题目链接
            if (currentProblem.url) {
                document.getElementById('problem-url-link').href = currentProblem.url;
                document.getElementById('problem-url-link').style.display = 'inline';
                document.getElementById('problem-url-empty').style.display = 'none';
            } else {
                document.getElementById('problem-url-link').style.display = 'none';
                document.getElementById('problem-url-empty').style.display = 'inline';
            }

            // 所属比赛
            if (currentProblem.contestId) {
                const contest = contestManager.findContestById(currentProblem.contestId);
                if (contest) {
                    document.getElementById('problem-contest-link').href = `contest-detail.html?id=${currentProblem.contestId}`;
                    document.getElementById('problem-contest-link').textContent = contest.name;
                    document.getElementById('problem-contest-link').style.display = 'inline';
                    document.getElementById('problem-contest-empty').style.display = 'none';
                } else {
                    document.getElementById('problem-contest-link').style.display = 'none';
                    document.getElementById('problem-contest-empty').style.display = 'inline';
                }
            } else {
                document.getElementById('problem-contest-link').style.display = 'none';
                document.getElementById('problem-contest-empty').style.display = 'inline';
            }

            // 加载相关文件
            await loadProblemFiles();

            // 标签
            if (currentProblem.tags && currentProblem.tags.length > 0) {
                document.getElementById('problem-tags-display').innerHTML = 
                    currentProblem.tags.map(tag => 
                        `<span class="tag tag-${getTagClass(tag)}">${escapeHtml(tag)}</span>`
                    ).join('');
                document.getElementById('problem-tags-section').style.display = 'block';
            } else {
                document.getElementById('problem-tags-section').style.display = 'none';
            }

            // 备注
            if (currentProblem.notes) {
                document.getElementById('problem-notes-display').textContent = currentProblem.notes;
                document.getElementById('problem-notes-section').style.display = 'block';
            } else {
                document.getElementById('problem-notes-section').style.display = 'none';
            }

            // 时间信息
            document.getElementById('problem-added-time').textContent = formatDateTime(currentProblem.addedTime);
            if (currentProblem.solvedTime) {
                document.getElementById('problem-solved-time').textContent = formatDateTime(currentProblem.solvedTime);
                document.getElementById('problem-solved-time-row').style.display = 'block';
            } else {
                document.getElementById('problem-solved-time-row').style.display = 'none';
            }
            document.getElementById('problem-times-section').style.display = 'block';

            // 渲染题解列表
            if (window.solutionManager) {
                window.solutionManager.renderSolutionsList(
                    currentProblem.solutions || [], 
                    'solutions-container', 
                    currentProblem.id, 
                    false
                );
            }
        }

        // 加载题目相关文件
        async function loadProblemFiles() {
            if (!currentProblem || !newFileManager) return;
            
            try {
                // 扫描题目文件状态
                const fileStatus = await newFileManager.scanProblemFiles(currentProblem.id);
                
                // 更新文件链接显示
                updateProblemFileLinks(fileStatus);
                
                console.log('题目文件状态加载完成:', fileStatus);
            } catch (error) {
                console.error('加载题目文件失败:', error);
                showNotification('加载题目文件失败: ' + error.message, 'error');
            }
        }
        
        // 更新题目文件链接显示
        function updateProblemFileLinks(fileStatus) {
            const elements = {
                statement: document.getElementById('problemStatementLink'),
                official: document.getElementById('officialSolutionLink')
            };

            // 题目描述文件
            if (elements.statement) {
                if (fileStatus.statement && fileStatus.statement.exists) {
                    elements.statement.innerHTML = `
                        <a href="${fileStatus.statement.path}" target="_blank" class="file-link-item">
                            ✅ 查看题目
                        </a>
                        <small class="file-info">最后检查: ${new Date(fileStatus.statement.lastChecked).toLocaleString()}</small>
                    `;
                } else if (fileStatus.statement) {
                    elements.statement.innerHTML = `
                        <span class="status pending">⏳ 文件未上传</span>
                        <small class="file-info">路径: ${fileStatus.statement.path}</small>
                    `;
                } else {
                    elements.statement.innerHTML = '<span class="status pending">⏳ 待扫描</span>';
                }
            }
            
            // 官方题解文件
            if (elements.official) {
                if (fileStatus.solutions && fileStatus.solutions.official && fileStatus.solutions.official.exists) {
                    elements.official.innerHTML = `
                        <a href="${fileStatus.solutions.official.path}" target="_blank" class="file-link-item">
                            ✅ 查看题解
                        </a>
                        <small class="file-info">最后检查: ${new Date(fileStatus.solutions.official.lastChecked).toLocaleString()}</small>
                    `;
                } else if (fileStatus.solutions && fileStatus.solutions.official) {
                    elements.official.innerHTML = `
                        <span class="status pending">⏳ 文件未上传</span>
                        <small class="file-info">路径: ${fileStatus.solutions.official.path}</small>
                    `;
                } else {
                    elements.official.innerHTML = '<span class="status pending">⏳ 待扫描</span>';
                }
            }
        }

        // 切换题目状态
        function toggleStatus() {
            try {
                const newStatus = currentProblem.status === 'solved' ? 'unsolved' : 'solved';
                problemManager.updateProblem(problemId, { status: newStatus });
            } catch (error) {
                showNotification('更新状态失败: ' + error.message, 'error');
            }
        }

        // 编辑题目
        function editProblem() {
            window.location.href = `problems.html?edit=${problemId}`;
        }

        // 生成题解模板
        function createSolutionTemplate() {
            try {
                const template = `# ${currentProblem.title} 题解

## 题目信息
- **平台**: ${currentProblem.platform}
- **题目编号**: ${currentProblem.problemIndex || '无'}
- **难度**: ${currentProblem.difficulty || '无'}
- **题目链接**: ${currentProblem.url || '无'}
- **状态**: ${currentProblem.status === 'solved' ? '✅ 已解决' : '❌ 未解决'}

## 题目描述
[在此添加题目描述或关键信息]

## 解题思路
[在此描述解题思路和方法]

## 算法/数据结构
[使用的算法或数据结构]

## 代码实现
\`\`\`cpp
// 在此添加代码
\`\`\`

## 复杂度分析
- **时间复杂度**: O(?)
- **空间复杂度**: O(?)

## 总结
[解题总结和收获]

## 相关题目
[类似题目或扩展题目]

---
*题解创建时间: ${new Date().toLocaleString('zh-CN')}*
`;

                const blob = new Blob([template], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentProblem.title}-题解.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('题解模板下载成功', 'success');
            } catch (error) {
                showNotification('生成题解模板失败: ' + error.message, 'error');
            }
        }

        // 复制题目信息
        function copyProblemInfo() {
            try {
                const info = `${currentProblem.title}
平台: ${currentProblem.platform}
编号: ${currentProblem.problemIndex || '无'}
难度: ${currentProblem.difficulty || '无'}
状态: ${currentProblem.status === 'solved' ? '✅ 已解决' : '❌ 未解决'}
链接: ${currentProblem.url || '无'}`;

                navigator.clipboard.writeText(info).then(() => {
                    showNotification('题目信息已复制到剪贴板', 'success');
                }).catch(() => {
                    // 降级方案
                    const textArea = document.createElement('textarea');
                    textArea.value = info;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('题目信息已复制到剪贴板', 'success');
                });
            } catch (error) {
                showNotification('复制失败: ' + error.message, 'error');
            }
        }

        // 添加到自定义比赛
        function addToCustomContest() {
            // 这里可以实现添加到自定义比赛的功能
            showNotification('此功能正在开发中', 'info');
        }

        // 打开题解管理器
        function openSolutionManager() {
            if (!currentProblem) {
                showNotification('题目信息未加载', 'error');
                return;
            }
            
            // 保存当前题目ID到localStorage
            localStorage.setItem('current-problem-id', currentProblem.id);
            
            // 在新窗口中打开题解管理器
            const managerWindow = window.open(
                `solution-manager.html?problemId=${encodeURIComponent(currentProblem.id)}`,
                'solution-manager',
                'width=1000,height=800,scrollbars=yes,resizable=yes'
            );
            
            if (!managerWindow) {
                showNotification('无法打开题解管理器窗口，请检查浏览器的弹窗设置', 'error');
            } else {
                showNotification('题解管理器已打开', 'success');
            }
        }

        // 返回上一页
        function goBack() {
            window.location.href = 'problems.html';
        }

        // 工具函数
        function formatDateTime(dateString) {
            try {
                return new Date(dateString).toLocaleString('zh-CN');
            } catch {
                return dateString;
            }
        }

        function getTagClass(tag) {
            const tagClasses = {
                'dp': 'dp',
                'greedy': 'greedy', 
                'graph': 'graph',
                'math': 'math',
                'string': 'string'
            };
            return tagClasses[tag] || 'default';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            if (storage && storage.showNotification) {
                storage.showNotification(message, type);
            } else {
                alert(message);
            }
        }
        
        // 加载题解作者信息
        async function loadSolutionAuthors() {
            if (!currentProblem || !problemManager) return;
            
            try {
                // 获取题目的所有作者
                const authors = problemManager.getProblemAuthors(currentProblem.id);
                
                // 渲染作者列表
                renderSolutionAuthors(authors);
                
                console.log('题解作者加载完成:', authors);
            } catch (error) {
                console.error('加载题解作者失败:', error);
                showNotification('加载题解作者失败: ' + error.message, 'error');
            }
        }
        
        // 渲染题解作者列表
        function renderSolutionAuthors(authors) {
            const container = document.getElementById('solution-authors-container');
            if (!container) return;
            
            if (!authors || authors.length === 0) {
                container.innerHTML = `
                    <div class="empty-authors">
                        <p class="text-gray-500">暂无题解作者</p>
                        <p class="text-sm text-gray-400">点击上方按钮添加第一个作者</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            authors.forEach(author => {
                const statusClass = author.status === 'uploaded' ? 'status-success' : 'status-pending';
                const statusText = author.status === 'uploaded' ? '✅ 已上传' : '⏳ 待上传';
                
                html += `
                    <div class="author-item">
                        <div class="author-info">
                            <div class="author-avatar">${author.author.charAt(0).toUpperCase()}</div>
                            <div class="author-details">
                                <h4 class="author-name">${escapeHtml(author.author)}</h4>
                                <p class="author-path">${escapeHtml(author.path)}</p>
                                <span class="author-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="author-actions">
                            <button type="button" class="btn btn-outline btn-xs" onclick="showAuthorFileGuidance('${author.key}', '${escapeHtml(author.path)}')"> 
                                📁 上传指导
                            </button>
                            <button type="button" class="btn btn-outline btn-xs" onclick="refreshAuthorStatus('${author.key}')">
                                🔄 刷新
                            </button>
                            ${author.key !== 'official' ? `
                                <button type="button" class="btn btn-danger btn-xs" onclick="removeAuthor('${author.key}')">
                                    🗑️ 删除
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 刷新题目文件状态
        async function refreshProblemFiles() {
            showNotification('正在刷新文件状态...', 'info');
            await loadProblemFiles();
            showNotification('文件状态刷新完成', 'success');
        }
        
        // 刷新题解作者信息
        async function refreshSolutionAuthors() {
            showNotification('正在刷新作者信息...', 'info');
            await loadSolutionAuthors();
            showNotification('作者信息刷新完成', 'success');
        }
        
        // 显示题目文件上传指导
        function showProblemFileUploadGuidance() {
            if (!currentProblem || !newFileManager) {
                showNotification('无法获取题目信息', 'error');
                return;
            }

            // 创建题目文件结构
            const fileStructure = newFileManager.createProblemStructure(currentProblem.id);

            // 创建指导模态框
            const modal = document.createElement('div');
            modal.className = 'file-guidance-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 700px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    font-family: system-ui, -apple-system, sans-serif;
                ">
                    <h3 style="margin: 0 0 20px 0; color: #333;">
                        📁 题目 ${currentProblem.id} 文件上传指导
                    </h3>
                    <div class="file-paths">
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4caf50;">
                            <strong>题目描述:</strong><br>
                            <code style="background: #fff; padding: 5px 8px; border-radius: 3px; font-size: 12px; color: #e91e63; word-break: break-all; display: block; margin-top: 5px;">
                                ${fileStructure.statement}
                            </code>
                        </div>
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #2196f3;">
                            <strong>官方题解:</strong><br>
                            <code style="background: #fff; padding: 5px 8px; border-radius: 3px; font-size: 12px; color: #e91e63; word-break: break-all; display: block; margin-top: 5px;">
                                ${fileStructure.solutions.official}
                            </code>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            padding: 10px 20px;
                            background: #2196f3;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                        ">关闭</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 显示添加作者模态框
        function showAddAuthorModal() {
            if (!currentProblem) {
                showNotification('题目信息未加载', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'add-author-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    font-family: system-ui, -apple-system, sans-serif;
                ">
                    <h3 style="margin: 0 0 20px 0; color: #333;">
                        ⭐ 添加题解作者
                    </h3>
                    <form id="addAuthorForm" onsubmit="handleAddAuthor(event)">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">作者姓名 *</label>
                            <input type="text" id="newAuthorName" placeholder="请输入作者姓名（如: 张同学）" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 14px;
                                box-sizing: border-box;
                            " required>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">显示名称</label>
                            <input type="text" id="newAuthorDisplayName" placeholder="显示名称（可选，默认与姓名相同）" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                font-size: 14px;
                                box-sizing: border-box;
                            ">
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" onclick="this.closest('.add-author-modal').remove()" style="
                                padding: 10px 20px;
                                background: #6b7280;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                                margin-right: 10px;
                            ">取消</button>
                            <button type="submit" style="
                                padding: 10px 20px;
                                background: #2196f3;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;
                            ">添加作者</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            
            // 聚焦到输入框
            setTimeout(() => {
                const input = modal.querySelector('#newAuthorName');
                if (input) input.focus();
            }, 100);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 处理添加作者
        async function handleAddAuthor(event) {
            event.preventDefault();
            
            const authorName = document.getElementById('newAuthorName').value.trim();
            const displayName = document.getElementById('newAuthorDisplayName').value.trim() || authorName;
            
            if (!authorName) {
                showNotification('请输入作者姓名', 'warning');
                return;
            }
            
            try {
                await problemManager.addSolutionAuthor(currentProblem.id, authorName, displayName);
                
                // 关闭模态框
                document.querySelector('.add-author-modal')?.remove();
                
                // 刷新作者列表
                await loadSolutionAuthors();
                
                showNotification(`作者 "${authorName}" 添加成功`, 'success');
            } catch (error) {
                showNotification('添加作者失败: ' + error.message, 'error');
            }
        }
        
        // 显示作者文件指导
        function showAuthorFileGuidance(authorKey, filePath) {
            const modal = document.createElement('div');
            modal.className = 'author-file-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 600px;
                    width: 90%;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    font-family: system-ui, -apple-system, sans-serif;
                ">
                    <h3 style="margin: 0 0 20px 0; color: #333;">
                        📁 作者文件上传指导
                    </h3>
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #2196f3;">
                        <strong>文件路径:</strong><br>
                        <code style="background: #fff; padding: 5px 8px; border-radius: 3px; font-size: 12px; color: #e91e63; word-break: break-all; display: block; margin-top: 5px;">
                            ${filePath}
                        </code>
                    </div>
                    <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <strong>上传步骤:</strong><br>
                        <ol style="margin: 10px 0 0 20px; padding: 0;">
                            <li>准备好题解文件（PDF、Markdown等）</li>
                            <li>将文件命名为 <code>solution.pdf</code> 或 <code>solution.md</code></li>
                            <li>手动复制文件到上述路径</li>
                            <li>点击刷新按钮检查文件状态</li>
                        </ol>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            padding: 10px 20px;
                            background: #2196f3;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 14px;
                        ">关闭</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 刷新作者状态
        async function refreshAuthorStatus(authorKey) {
            showNotification('正在刷新作者状态...', 'info');
            await loadSolutionAuthors();
            showNotification('作者状态刷新完成', 'success');
        }
        
        // 删除作者
        async function removeAuthor(authorKey) {
            if (!currentProblem) return;
            
            if (confirm('确定要删除这个作者的题解吗？')) {
                try {
                    await problemManager.removeSolutionAuthor(currentProblem.id, authorKey);
                    await loadSolutionAuthors();
                    showNotification('作者删除成功', 'success');
                } catch (error) {
                    showNotification('删除作者失败: ' + error.message, 'error');
                }
            }
        }
    </script>
    
    <style>
        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .form-value {
            padding: 0.5rem 0;
            color: #374151;
            font-weight: 500;
        }

        .form-value a {
            color: #3b82f6;
            text-decoration: none;
        }

        .form-value a:hover {
            text-decoration: underline;
        }

        .time-info div {
            margin-bottom: 0.25rem;
        }

        .time-info div:last-child {
            margin-bottom: 0;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-solved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-todo {
            background: #fee2e2;
            color: #991b1b;
        }

        .difficulty-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
        }

        .difficulty-800 { background: #22c55e; }
        .difficulty-1000 { background: #84cc16; }
        .difficulty-1200 { background: #eab308; }
        .difficulty-1400 { background: #f97316; }
        .difficulty-1600 { background: #ef4444; }
        .difficulty-1800 { background: #dc2626; }
        .difficulty-2000 { background: #b91c1c; }
        .difficulty-2200 { background: #7c2d12; }
        .difficulty-2400 { background: #374151; }
        .difficulty-2600 { background: #1f2937; }
        .difficulty-2800 { background: #111827; }
        .difficulty-3000 { background: #000000; }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            padding: 0.25rem 0.5rem;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #374151;
        }

        .tag-dp { background: #dbeafe; color: #1d4ed8; }
        .tag-greedy { background: #dcfce7; color: #166534; }
        .tag-graph { background: #f3e8ff; color: #7c3aed; }
        .tag-math { background: #fef3c7; color: #d97706; }
        .tag-string { background: #fce7f3; color: #be185d; }

        /* 文件链接样式 */
        .file-link {
            display: inline-block;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-decoration: none;
            color: #374151;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .file-link:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
            text-decoration: none;
        }

        .file-link-pdf {
            border-left: 3px solid #dc2626;
        }

        .file-link-md {
            border-left: 3px solid #059669;
        }

        .file-section {
            margin-bottom: 1rem;
        }

        .file-section h4 {
            display: none; /* 隐藏section标题，因为我们在form-label中已经有了 */
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-red-500 {
            color: #ef4444;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .text-gray-400 {
            color: #9ca3af;
        }
        
        /* 文件显示样式 */
        .problem-files-section {
            margin-bottom: 1.5rem;
        }
        
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .file-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-info h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }
        
        .file-link-item {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            background: #2196f3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
        }
        
        .file-link-item:hover {
            background: #1976d2;
            text-decoration: none;
            color: white;
        }
        
        .file-info small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status.pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        /* 作者管理样式 */
        .empty-authors {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .author-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .author-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .author-avatar {
            width: 40px;
            height: 40px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .author-details {
            flex: 1;
        }
        
        .author-name {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }
        
        .author-path {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            color: #6b7280;
            font-family: monospace;
            word-break: break-all;
        }
        
        .author-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .author-status.status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .author-status.status-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .author-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    </style>
</body>
</html>