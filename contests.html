<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯”èµ›ç®¡ç† - ACMä¸­è½¬ç«™</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ACMä¸­è½¬ç«™</a>
            <ul class="navbar-nav">
                <li><a href="index.html">ä»ªè¡¨æ¿</a></li>
                <li><a href="contests.html" class="active">æ¯”èµ›ç®¡ç†</a></li>
                <li><a href="problems.html">é¢˜ç›®ç®¡ç†</a></li>
            </ul>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h1 class="page-title">æ¯”èµ›ç®¡ç†</h1>
            <p class="page-subtitle">è®°å½•å’Œç®¡ç†ä½ çš„ACMç«èµ›å†ç¨‹</p>
        </div>

        <!-- å¿«é€Ÿç»Ÿè®¡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-contests">0</div>
                <div class="stat-label">æ€»æ¯”èµ›æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-solved">0</div>
                <div class="stat-label">æ€»è§£é¢˜æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-rank">-</div>
                <div class="stat-label">å¹³å‡æ’å</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recent-contests">0</div>
                <div class="stat-label">æœ¬æœˆæ¯”èµ›</div>
            </div>
        </div>

        <!-- æ·»åŠ æ¯”èµ›è¡¨å• -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æ·»åŠ æ–°æ¯”èµ›</h2>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="resetForm()">é‡ç½®è¡¨å•</button>
                    <button class="btn btn-secondary btn-sm" onclick="importContests()">å¯¼å…¥æ•°æ®</button>
                    <button class="btn btn-primary btn-sm" onclick="exportContests()">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>
            <div class="form-container">
                <form id="contest-form" onsubmit="handleSubmitContest(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="contest-name">æ¯”èµ›åç§° *</label>
                            <input type="text" id="contest-name" class="form-control" placeholder="è¾“å…¥æ¯”èµ›åç§°" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contest-platform">æ¯”èµ›å¹³å° *</label>
                            <select id="contest-platform" class="form-control" required>
                                <option value="">é€‰æ‹©å¹³å°</option>
                                <option value="Codeforces">Codeforces</option>
                                <option value="AtCoder">AtCoder</option>
                                <option value="CodeChef">CodeChef</option>
                                <option value="ICPC">ICPC</option>
                                <option value="CCPC">CCPC</option>
                                <option value="NowCoder">NowCoder</option>
                                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contest-date">æ¯”èµ›æ—¥æœŸ *</label>
                            <input type="date" id="contest-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contest-rank">æœ€ç»ˆæ’å</label>
                            <input type="text" id="contest-rank" class="form-control" placeholder="å¦‚: 100/2000">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contest-solved">è§£é¢˜æ•°é‡</label>
                            <input type="number" id="contest-solved" class="form-control" placeholder="è§£é¢˜æ•°" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="contest-total">é¢˜ç›®æ€»æ•°</label>
                            <input type="number" id="contest-total" class="form-control" placeholder="æ€»é¢˜æ•°" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="auto-generate-count">è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®</label>
                            <select id="auto-generate-count" class="form-control">
                                <option value="0">ä¸ç”Ÿæˆé¢˜ç›®</option>
                                <option value="5">ç”Ÿæˆ5é¢˜ (å°å‹ç»ƒä¹ èµ›)</option>
                                <option value="6">ç”Ÿæˆ6é¢˜ (AtCoderå¸¸è§)</option>
                                <option value="7">ç”Ÿæˆ7é¢˜ (Div.2å¸¸è§)</option>
                                <option value="8">ç”Ÿæˆ8é¢˜</option>
                                <option value="9">ç”Ÿæˆ9é¢˜</option>
                                <option value="10">ç”Ÿæˆ10é¢˜</option>
                                <option value="11">ç”Ÿæˆ11é¢˜ (ICPCå¸¸è§)</option>
                                <option value="12">ç”Ÿæˆ12é¢˜</option>
                                <option value="13">ç”Ÿæˆ13é¢˜ (ICPC World Finals)</option>
                                <option value="14">ç”Ÿæˆ14é¢˜</option>
                                <option value="15">ç”Ÿæˆ15é¢˜ (å¤§å‹æ¯”èµ›)</option>
                            </select>
                            <small class="form-help">é€‰æ‹©è‡ªåŠ¨ç”ŸæˆA-Oç¼–å·çš„é¢˜ç›®æ•°é‡ï¼Œé¢˜ç›®å°†åŒæ­¥åˆ°é¢˜ç›®åº“ä¸­</small>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="contest-url">æ¯”èµ›é“¾æ¥</label>
                            <input type="url" id="contest-url" class="form-control" placeholder="https://...">
                        </div>
                    </div>
                    <div class="form-section">
                        <h3 class="section-title">ğŸ“ æ–‡ä»¶ç®¡ç†</h3>
                        <div class="file-upload-area">
                            <div class="upload-item">
                                <label class="form-label">æ¯”èµ›é¢˜é¢ (contest.pdf)</label>
                                <input type="file" id="contestStatement" class="form-control" accept=".pdf">
                                <div class="file-guidance" id="statementGuidance" style="display:none;"></div>
                            </div>
                            <div class="upload-item">
                                <label class="form-label">å®˜æ–¹é¢˜è§£ (editorial.pdf)</label>
                                <input type="file" id="contestSolution" class="form-control" accept=".pdf">
                                <div class="file-guidance" id="solutionGuidance" style="display:none;"></div>
                            </div>
                            <div class="upload-item">
                                <label class="form-label">æ¯”èµ›æ€»ç»“ (review.pdf)</label>
                                <input type="file" id="contestSummary" class="form-control" accept=".pdf">
                                <div class="file-guidance" id="summaryGuidance" style="display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡ä»¶çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
                    <div class="file-status-section" id="fileStatus" style="display:none;">
                        <h4 class="section-subtitle">ğŸ“Š æ–‡ä»¶çŠ¶æ€</h4>
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="status-label">é¢˜é¢æ–‡ä»¶:</span>
                                <span class="status-indicator" id="statementStatus">â³ å¾…ä¸Šä¼ </span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">å®˜æ–¹é¢˜è§£:</span>
                                <span class="status-indicator" id="solutionStatus">â³ å¾…ä¸Šä¼ </span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">æ¯”èµ›æ€»ç»“:</span>
                                <span class="status-indicator" id="summaryStatus">â³ å¾…ä¸Šä¼ </span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="contest-notes">å¤‡æ³¨</label>
                        <textarea id="contest-notes" class="form-control" placeholder="æ¯”èµ›æ€»ç»“ã€æ”¶è·ã€é—®é¢˜ç­‰"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">æ·»åŠ æ¯”èµ›</button>
                        <button type="button" class="btn btn-outline" onclick="resetForm()">æ¸…ç©º</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="search-bar">
            <div class="search-grid">
                <div class="search-input">
                    <input type="text" id="search-query" class="form-control" placeholder="æœç´¢æ¯”èµ›åç§°ã€å¹³å°ã€å¤‡æ³¨..." onkeyup="handleSearch()">
                </div>
                <div class="form-group">
                    <select id="filter-platform" class="form-control" onchange="handleSearch()">
                        <option value="">æ‰€æœ‰å¹³å°</option>
                        <option value="Codeforces">Codeforces</option>
                        <option value="AtCoder">AtCoder</option>
                        <option value="CodeChef">CodeChef</option>
                        <option value="ICPC">ICPC</option>
                        <option value="CCPC">CCPC</option>
                        <option value="NowCoder">NowCoder</option>
                        <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <select id="sort-by" class="form-control" onchange="handleSort()">
                        <option value="date">æŒ‰æ—¥æœŸæ’åº</option>
                        <option value="name">æŒ‰åç§°æ’åº</option>
                        <option value="platform">æŒ‰å¹³å°æ’åº</option>
                        <option value="solved">æŒ‰è§£é¢˜æ•°æ’åº</option>
                        <option value="addedTime">æŒ‰æ·»åŠ æ—¶é—´æ’åº</option>
                    </select>
                </div>
                <button class="btn btn-outline btn-sm" onclick="clearFilters()">æ¸…ç©ºç­›é€‰</button>
            </div>
        </div>

        <!-- æ¯”èµ›åˆ—è¡¨ -->
        <div class="table-container">
            <div class="table-header">
                <h3>æ¯”èµ›è®°å½•</h3>
                <div class="btn-group">
                    <span id="contest-count" class="text-gray-500">å…± 0 åœºæ¯”èµ›</span>
                    <button class="btn btn-sm btn-outline" onclick="refreshData()">åˆ·æ–°</button>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="handleTableSort('name')">æ¯”èµ›åç§°</th>
                        <th class="sortable" onclick="handleTableSort('platform')">å¹³å°</th>
                        <th class="sortable" onclick="handleTableSort('date')">æ—¥æœŸ</th>
                        <th class="sortable" onclick="handleTableSort('rank')">æ’å</th>
                        <th class="sortable" onclick="handleTableSort('solved')">è§£é¢˜</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="contests-table-body">
                    <!-- åŠ¨æ€åŠ è½½æ¯”èµ›æ•°æ® -->
                </tbody>
            </table>
            <div id="no-contests" class="text-center p-4 hidden">
                <p class="text-gray-500">æš‚æ— æ¯”èµ›è®°å½•</p>
                <p class="text-gray-500">ä½¿ç”¨ä¸Šé¢çš„è¡¨å•æ·»åŠ ä½ çš„ç¬¬ä¸€åœºæ¯”èµ›å§ï¼</p>
            </div>
        </div>

        <!-- åˆ†é¡µ -->
        <div id="pagination" class="pagination hidden">
            <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)" disabled>ä¸Šä¸€é¡µ</button>
            <span class="pagination-info">ç¬¬ <span id="current-page">1</span> é¡µï¼Œå…± <span id="total-pages">1</span> é¡µ</span>
            <button class="pagination-btn" id="next-btn" onclick="changePage(1)" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¯”èµ›æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘æ¯”èµ›</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-contest-form" onsubmit="handleUpdateContest(event)">
                    <input type="hidden" id="edit-contest-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-name">æ¯”èµ›åç§° *</label>
                            <input type="text" id="edit-contest-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-platform">æ¯”èµ›å¹³å° *</label>
                            <select id="edit-contest-platform" class="form-control" required>
                                <option value="Codeforces">Codeforces</option>
                                <option value="AtCoder">AtCoder</option>
                                <option value="CodeChef">CodeChef</option>
                                <option value="ICPC">ICPC</option>
                                <option value="CCPC">CCPC</option>
                                <option value="NowCoder">NowCoder</option>
                                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-date">æ¯”èµ›æ—¥æœŸ *</label>
                            <input type="date" id="edit-contest-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-rank">æœ€ç»ˆæ’å</label>
                            <input type="text" id="edit-contest-rank" class="form-control" placeholder="å¦‚: 100/2000">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-solved">è§£é¢˜æ•°é‡</label>
                            <input type="number" id="edit-contest-solved" class="form-control" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-total">é¢˜ç›®æ€»æ•°</label>
                            <input type="number" id="edit-contest-total" class="form-control" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-auto-generate-count">è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®</label>
                            <select id="edit-auto-generate-count" class="form-control">
                                <option value="0">ä¸ç”Ÿæˆé¢˜ç›®</option>
                                <option value="5">ç”Ÿæˆ5é¢˜ (å°å‹ç»ƒä¹ èµ›)</option>
                                <option value="6">ç”Ÿæˆ6é¢˜ (AtCoderå¸¸è§)</option>
                                <option value="7">ç”Ÿæˆ7é¢˜ (Div.2å¸¸è§)</option>
                                <option value="8">ç”Ÿæˆ8é¢˜</option>
                                <option value="9">ç”Ÿæˆ9é¢˜</option>
                                <option value="10">ç”Ÿæˆ10é¢˜</option>
                                <option value="11">ç”Ÿæˆ11é¢˜ (ICPCå¸¸è§)</option>
                                <option value="12">ç”Ÿæˆ12é¢˜</option>
                                <option value="13">ç”Ÿæˆ13é¢˜ (ICPC World Finals)</option>
                                <option value="14">ç”Ÿæˆ14é¢˜</option>
                                <option value="15">ç”Ÿæˆ15é¢˜ (å¤§å‹æ¯”èµ›)</option>
                            </select>
                            <small class="form-help">ç¼–è¾‘æ—¶ç”Ÿæˆé¢˜ç›®å°†è¿½åŠ åˆ°ç°æœ‰é¢˜ç›®ä¸­</small>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="edit-contest-url">æ¯”èµ›é“¾æ¥</label>
                            <input type="url" id="edit-contest-url" class="form-control">
                        </div>
                    </div>
                    <div class="form-section">
                        <h3 class="section-title">ğŸ“ æ–‡ä»¶ç®¡ç†</h3>
                        <div class="file-upload-area">
                            <div class="upload-item">
                                <label class="form-label">æ¯”èµ›é¢˜é¢ (contest.pdf)</label>
                                <input type="file" id="editContestStatement" class="form-control" accept=".pdf">
                                <div class="file-guidance" id="editStatementGuidance" style="display:none;"></div>
                            </div>
                            <div class="upload-item">
                                <label class="form-label">å®˜æ–¹é¢˜è§£ (editorial.pdf)</label>
                                <input type="file" id="editContestSolution" class="form-control" accept=".pdf">
                                <div class="file-guidance" id="editSolutionGuidance" style="display:none;"></div>
                            </div>
                            <div class="upload-item">
                                <label class="form-label">æ¯”èµ›æ€»ç»“ (review.pdf)</label>
                                <input type="file" id="editContestSummary" class="form-control" accept=".pdf">
                                <div class="file-guidance" id="editSummaryGuidance" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-contest-notes">å¤‡æ³¨</label>
                        <textarea id="edit-contest-notes" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button type="submit" form="edit-contest-form" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½ JavaScript -->
    <script src="js/storage.js"></script>
    <script src="js/new-file-manager.js"></script>
    <script src="js/contest-generator.js"></script>
    <script src="js/contests.js"></script>
    <script src="js/search.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let storage, contestManager, globalSearch;
        let currentContests = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentSort = { field: 'date', order: 'desc' };

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // åˆå§‹åŒ–å­˜å‚¨å’Œç®¡ç†å™¨
                storage = new DataStorage();
                contestManager = new ContestManager(storage);

                // åˆå§‹åŒ–å…¨å±€æœç´¢
                try {
                    globalSearch = new GlobalSearchManager(storage);
                    console.log('å…¨å±€æœç´¢åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('åˆå§‹åŒ–å…¨å±€æœç´¢å¤±è´¥:', error);
                }

                // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
                await new Promise(resolve => {
                    if (contestManager.initialized) {
                        resolve();
                    } else {
                        contestManager.on('initialized', resolve);
                    }
                });

                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                
                // åŠ è½½æ•°æ®
                await loadData();
                
                console.log('æ¯”èµ›ç®¡ç†é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            contestManager.on('contestAdded', () => {
                loadData();
                showNotification('æ¯”èµ›æ·»åŠ æˆåŠŸ', 'success');
            });

            contestManager.on('contestUpdated', () => {
                loadData();
                showNotification('æ¯”èµ›æ›´æ–°æˆåŠŸ', 'success');
            });

            contestManager.on('contestDeleted', () => {
                loadData();
                showNotification('æ¯”èµ›åˆ é™¤æˆåŠŸ', 'success');
            });

            // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.getElementById('edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
        }

        // åŠ è½½æ•°æ®å¹¶æ›´æ–°UI
        async function loadData() {
            try {
                currentContests = contestManager.getAllContests();
                updateStatistics();
                renderTable();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const stats = contestManager.getStatistics();
            
            document.getElementById('total-contests').textContent = stats.total;
            document.getElementById('total-solved').textContent = stats.totalSolved;
            document.getElementById('average-rank').textContent = stats.averageRank || '-';
            
            // è®¡ç®—æœ¬æœˆæ¯”èµ›æ•°
            const thisMonth = new Date().toISOString().substring(0, 7);
            const monthlyContests = currentContests.filter(contest => 
                contest.date.substring(0, 7) === thisMonth
            ).length;
            document.getElementById('recent-contests').textContent = monthlyContests;
        }

        // æ¸²æŸ“æ¯”èµ›è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('contests-table-body');
            const noContests = document.getElementById('no-contests');
            
            if (currentContests.length === 0) {
                tbody.innerHTML = '';
                noContests.classList.remove('hidden');
                document.getElementById('contest-count').textContent = 'å…± 0 åœºæ¯”èµ›';
                return;
            }

            noContests.classList.add('hidden');
            document.getElementById('contest-count').textContent = `å…± ${currentContests.length} åœºæ¯”èµ›`;

            // åˆ†é¡µ
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageContests = currentContests.slice(startIndex, endIndex);

            tbody.innerHTML = pageContests.map(contest => `
                <tr>
                    <td>
                        <div class="font-weight-500">${escapeHtml(contest.name)}</div>
                        ${contest.notes ? `<div class="text-gray-500 text-sm">${escapeHtml(contest.notes.substring(0, 50))}${contest.notes.length > 50 ? '...' : ''}</div>` : ''}
                    </td>
                    <td>
                        <span class="tag">${escapeHtml(contest.platform)}</span>
                    </td>
                    <td>${formatDate(contest.date)}</td>
                    <td>${contest.rank || '-'}</td>
                    <td>
                        ${contest.solved || 0}${contest.totalProblems ? `/${contest.totalProblems}` : ''}
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewContestDetail('${contest.id}')">è¯¦æƒ…</button>
                            <button class="btn btn-sm btn-outline" onclick="editContest('${contest.id}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteContest('${contest.id}')">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updatePagination();
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const totalPages = Math.ceil(currentContests.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            
            document.getElementById('prev-btn').disabled = currentPage <= 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
        }

        // ç¿»é¡µ
        function changePage(delta) {
            const totalPages = Math.ceil(currentContests.length / itemsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(fileInput, folder) {
            // æ£€æŸ¥ fileInput æ˜¯å¦ä¸º null æˆ– undefined
            if (!fileInput || !fileInput.files) {
                return '';
            }
            
            const file = fileInput.files[0];
            if (file) {
                // ç”Ÿæˆæ ‡å‡†åŒ–æ–‡ä»¶å
                const sanitizedName = file.name.replace(/[^\w\-\.]/g, '_');
                const relativePath = `./files/${folder}/${sanitizedName}`;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿å­˜æŒ‡å¯¼
                const fullPath = `/home/zyn/program/2025-Summer/ACM-Transit/Context-Engineering-Intro/acm-transit/files/${folder}/${sanitizedName}`;
                
                showFileUploadGuide(file.name, sanitizedName, fullPath, folder);
                
                return relativePath;
            }
            return '';
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ æŒ‡å¯¼
        function showFileUploadGuide(originalName, sanitizedName, fullPath, folder) {
            const message = `
æ–‡ä»¶ä¸Šä¼ æŒ‡å¯¼ï¼š
\nåŸæ–‡ä»¶å: ${originalName}
æ ‡å‡†åŒ–åç§°: ${sanitizedName}
\nè¯·æ‰‹åŠ¨å°†æ–‡ä»¶å¤åˆ¶åˆ°ï¼š
${fullPath}
\næˆ–è€…ä½¿ç”¨å‘½ä»¤ï¼š
cp â€œæ–‡ä»¶è·¯å¾„â€ â€œ${fullPath}â€
\næ–‡ä»¶å·²ç™»è®°åˆ°ç³»ç»Ÿä¸­ï¼Œä½†éœ€è¦æ‚¨æ‰‹åŠ¨æ”¾ç½®æ–‡ä»¶æ‰èƒ½æ­£å¸¸è®¿é—®ã€‚
            `;
            
            if (confirm(message + '\n\nç‚¹å‡»ç¡®å®šç»§ç»­ï¼Œå–æ¶ˆåˆ™ä¸ä¿å­˜æ–‡ä»¶è·¯å¾„ã€‚')) {
                console.log('æ–‡ä»¶ä¸Šä¼ æŒ‡å¯¼:', { originalName, sanitizedName, fullPath, folder });
                return true;
            }
            return false;
        }

        // å¤„ç†æ¯”èµ›æäº¤
        function handleSubmitContest(event) {
            event.preventDefault();
            
            try {
                const formData = {
                    name: document.getElementById('contest-name').value,
                    platform: document.getElementById('contest-platform').value,
                    date: document.getElementById('contest-date').value,
                    rank: document.getElementById('contest-rank').value,
                    solved: document.getElementById('contest-solved').value,
                    totalProblems: document.getElementById('contest-total').value,
                    url: document.getElementById('contest-url').value,
                    // ç§»é™¤æ—§çš„ PDF è·¯å¾„ï¼Œæ–°ç³»ç»Ÿä¸å†éœ€è¦è¿™ä¸ªå­—æ®µ
                    pdfPath: '',
                    summaryPath: '',
                    notes: document.getElementById('contest-notes').value,
                    autoGenerateCount: document.getElementById('auto-generate-count').value
                };

                contestManager.addContest(formData);
                resetForm();
                
            } catch (error) {
                showNotification('æ·»åŠ æ¯”èµ›å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('contest-form').reset();
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('contest-date').value = new Date().toISOString().split('T')[0];
        }

        // é˜²æŠ–æœç´¢å¤„ç†
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            try {
                const query = document.getElementById('search-query')?.value || '';
                const platform = document.getElementById('filter-platform')?.value || '';
                
                console.log('æ‰§è¡Œæ¯”èµ›æœç´¢ï¼Œæ¡ä»¶:', { query, platform });
                
                const criteria = {};
                if (query.trim()) criteria.search = query.trim();
                if (platform) criteria.platform = platform;
                
                currentContests = contestManager.filterContests(criteria);
                console.log('æœç´¢ç»“æœ:', currentContests.length, 'åœºæ¯”èµ›');
                
                applySorting();
                currentPage = 1;
                renderTable();
            } catch (error) {
                console.error('æ¯”èµ›æœç´¢å¤±è´¥:', error);
                showNotification('æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ’åºå¤„ç†
        function handleSort() {
            const sortBy = document.getElementById('sort-by').value;
            currentSort.field = sortBy;
            applySorting();
            renderTable();
        }

        // è¡¨æ ¼æ’åº
        function handleTableSort(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'desc';
            }
            
            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const targetTh = event.target;
            targetTh.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
            
            applySorting();
            renderTable();
        }

        // åº”ç”¨æ’åº - ä¿®å¤ç‰ˆæœ¬ï¼šå¯¹å·²ç­›é€‰çš„ç»“æœè¿›è¡Œæ’åº
        function applySorting() {
            if (currentContests && currentContests.length > 0) {
                // å¯¹å½“å‰ç­›é€‰ç»“æœè¿›è¡Œæ’åº
                currentContests.sort((a, b) => {
                    let aValue = a[currentSort.field];
                    let bValue = b[currentSort.field];

                    // å¤„ç†æ—¥æœŸç±»å‹
                    if (currentSort.field === 'date' || currentSort.field === 'addedTime') {
                        aValue = aValue ? new Date(aValue) : new Date(0);
                        bValue = bValue ? new Date(bValue) : new Date(0);
                    }

                    // å¤„ç†æ•°å­—ç±»å‹
                    if (currentSort.field === 'solved' || currentSort.field === 'totalProblems') {
                        aValue = parseInt(aValue) || 0;
                        bValue = parseInt(bValue) || 0;
                    }

                    // å¤„ç†å­—ç¬¦ä¸²ç±»å‹
                    if (typeof aValue === 'string' && typeof bValue === 'string') {
                        const result = aValue.localeCompare(bValue, 'zh-CN');
                        return currentSort.order === 'desc' ? -result : result;
                    }

                    // å¤„ç†æ•°å­—å’Œæ—¥æœŸç±»å‹
                    if (aValue < bValue) return currentSort.order === 'desc' ? 1 : -1;
                    if (aValue > bValue) return currentSort.order === 'desc' ? -1 : 1;
                    return 0;
                });
            }
        }

        // æ¸…ç©ºç­›é€‰
        function clearFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('filter-platform').value = '';
            document.getElementById('sort-by').value = 'date';
            
            currentContests = contestManager.getAllContests();
            currentSort = { field: 'date', order: 'desc' };
            applySorting();
            currentPage = 1;
            renderTable();
        }

        // ç¼–è¾‘æ¯”èµ›
        function editContest(id) {
            const contest = contestManager.findContestById(id);
            if (!contest) {
                showNotification('æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¯”èµ›è®°å½•', 'error');
                return;
            }

            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('edit-contest-id').value = contest.id;
            document.getElementById('edit-contest-name').value = contest.name;
            document.getElementById('edit-contest-platform').value = contest.platform;
            document.getElementById('edit-contest-date').value = contest.date;
            document.getElementById('edit-contest-rank').value = contest.rank || '';
            document.getElementById('edit-contest-solved').value = contest.solved || '';
            document.getElementById('edit-contest-total').value = contest.totalProblems || '';
            document.getElementById('edit-contest-url').value = contest.url || '';
            // Note: File input cannot be pre-populated for security reasons
            document.getElementById('edit-contest-summary').value = contest.summaryPath || '';
            document.getElementById('edit-contest-notes').value = contest.notes || '';

            document.getElementById('edit-modal').classList.add('show');
        }

        // å¤„ç†æ¯”èµ›æ›´æ–°
        function handleUpdateContest(event) {
            event.preventDefault();
            
            try {
                const id = document.getElementById('edit-contest-id').value;
                const updates = {
                    name: document.getElementById('edit-contest-name').value,
                    platform: document.getElementById('edit-contest-platform').value,
                    date: document.getElementById('edit-contest-date').value,
                    rank: document.getElementById('edit-contest-rank').value,
                    solved: document.getElementById('edit-contest-solved').value,
                    totalProblems: document.getElementById('edit-contest-total').value,
                    url: document.getElementById('edit-contest-url').value,
                    // ç§»é™¤æ—§çš„ PDF è·¯å¾„ï¼Œæ–°ç³»ç»Ÿä¸å†éœ€è¦è¿™ä¸ªå­—æ®µ
                    pdfPath: '',
                    summaryPath: '',
                    notes: document.getElementById('edit-contest-notes').value,
                    autoGenerateCount: document.getElementById('edit-auto-generate-count').value
                };

                contestManager.updateContest(id, updates);
                closeEditModal();
                
            } catch (error) {
                showNotification('æ›´æ–°æ¯”èµ›å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
        }

        // æŸ¥çœ‹æ¯”èµ›è¯¦æƒ…é¡µé¢
        function viewContestDetail(id) {
            // è·³è½¬åˆ°æ¯”èµ›è¯¦æƒ…é¡µé¢
            window.location.href = `contest-detail.html?id=${id}`;
        }

        // åˆ é™¤æ¯”èµ›
        function deleteContest(id) {
            const contest = contestManager.findContestById(id);
            if (!contest) return;

            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¯”èµ› "${contest.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                try {
                    contestManager.deleteContest(id);
                } catch (error) {
                    showNotification('åˆ é™¤æ¯”èµ›å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // å¯¼å‡ºæ¯”èµ›æ•°æ®
        async function exportContests() {
            try {
                const success = await contestManager.exportContests('contests-export.json');
                if (success) {
                    showNotification('æ¯”èµ›æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
                }
            } catch (error) {
                showNotification('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å…¥æ¯”èµ›æ•°æ®
        async function importContests() {
            try {
                const data = await storage.importData();
                if (data) {
                    const result = await contestManager.importContests(data);
                    showNotification(`å¯¼å…¥æˆåŠŸï¼šæ–°å¢ ${result.addedCount} åœºæ¯”èµ›`, 'success');
                }
            } catch (error) {
                showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            try {
                await contestManager.reloadData();
                await loadData();
                showNotification('æ•°æ®åˆ·æ–°æˆåŠŸ', 'success');
            } catch (error) {
                showNotification('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString('zh-CN');
            } catch {
                return dateString;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            if (storage && storage.showNotification) {
                storage.showNotification(message, type);
            } else {
                alert(message);
            }
        }

        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('contest-date').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>